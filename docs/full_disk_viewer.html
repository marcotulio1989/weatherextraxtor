<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç GOES Full Disk Viewer - Reproje√ß√£o</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: linear-gradient(90deg, #1a1a2e, #16213e);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #00d4ff;
            flex-shrink: 0;
        }
        .header h1 {
            color: #00d4ff;
            font-size: 1.3em;
        }
        
        /* Controls */
        .controls {
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .control-group label {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
        }
        select, button, input[type="range"] {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #333;
            background: #1a1a2e;
            color: #e0e0e0;
            font-size: 0.9em;
            cursor: pointer;
        }
        select:focus, button:focus {
            outline: none;
            border-color: #00d4ff;
        }
        button {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
            font-weight: bold;
            border: none;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,212,255,0.3);
        }
        button.secondary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
        }
        
        /* Map Container */
        .map-wrapper {
            flex: 1;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Info Panel */
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.85);
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            z-index: 1000;
            min-width: 200px;
        }
        .info-panel h3 {
            color: #00d4ff;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #888; }
        .info-value { color: #00d4ff; font-weight: bold; }
        .info-value.error { color: #e74c3c; }
        .info-value.success { color: #2ecc71; }
        
        /* Opacity Slider */
        .opacity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .opacity-control input {
            width: 100px;
        }
        .opacity-value {
            color: #00d4ff;
            font-weight: bold;
            min-width: 40px;
        }
        
        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 30px 50px;
            border-radius: 10px;
            z-index: 9999;
            text-align: center;
        }
        .loading.hidden { display: none; }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Status Bar */
        .status-bar {
            background: rgba(0,0,0,0.8);
            padding: 8px 20px;
            font-size: 0.8em;
            color: #888;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üåç GOES Full Disk Viewer</h1>
        <div style="color: #888; font-size: 0.9em;">
            Reproje√ß√£o Geoestacion√°ria ‚Üí Plate Carr√©e
        </div>
    </header>
    
    <div class="controls">
        <div class="control-group">
            <label>üõ∞Ô∏è Sat√©lite</label>
            <select id="satelliteSelect">
                <option value="goes19">GOES-19 (East)</option>
                <option value="goes16">GOES-16 (East)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>üîß M√©todo de Reproje√ß√£o</label>
            <select id="methodSelect">
                <option value="manual">Manual (Matem√°tica Pura)</option>
                <option value="gdal">GDAL (rasterio + pyproj)</option>
                <option value="cartopy">Cartopy</option>
                <option value="satpy">SatPy (pyresample)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>üìê Qualidade</label>
            <select id="qualitySelect">
                <option value="1000">1000px (R√°pido)</option>
                <option value="2000" selected>2000px (Normal)</option>
                <option value="3000">3000px (Alta)</option>
                <option value="4000">4000px (M√°xima)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>üîç Opacidade</label>
            <div class="opacity-control">
                <input type="range" id="opacitySlider" min="0" max="100" value="70">
                <span class="opacity-value" id="opacityValue">70%</span>
            </div>
        </div>
        
        <button id="loadBtn" onclick="loadFullDisk()">
            üåç Carregar Full Disk
        </button>
        
        <button id="reprocessBtn" onclick="reprocessImage()" class="secondary">
            üîÑ Reprojetar
        </button>
        
        <button onclick="fitToBounds()">
            üìç Ajustar Vis√£o
        </button>
    </div>
    
    <div class="map-wrapper">
        <div id="map"></div>
        
        <div class="info-panel">
            <h3>üìä Informa√ß√µes</h3>
            <div class="info-row">
                <span class="info-label">Sat√©lite:</span>
                <span class="info-value" id="infoSatellite">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">M√©todo:</span>
                <span class="info-value" id="infoMethod">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Status:</span>
                <span class="info-value" id="infoStatus">Aguardando...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Bounds N:</span>
                <span class="info-value" id="infoBoundsN">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Bounds S:</span>
                <span class="info-value" id="infoBoundsS">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Bounds W:</span>
                <span class="info-value" id="infoBoundsW">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Bounds E:</span>
                <span class="info-value" id="infoBoundsE">-</span>
            </div>
        </div>
        
        <div class="loading hidden" id="loadingOverlay">
            <div class="spinner"></div>
            <div id="loadingText">Carregando...</div>
        </div>
    </div>
    
    <div class="status-bar">
        <span id="statusText">Pronto</span>
        <span id="lastUpdate">-</span>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // =====================================================
        // CONFIGURA√á√ÉO
        // =====================================================
        
        // GOES-19/16 Full Disk URLs
        const SATELLITES = {
            goes19: {
                name: 'GOES-19',
                fullDiskUrl: 'https://cdn.star.nesdis.noaa.gov/GOES19/ABI/FD/GEOCOLOR/latest.jpg',
                sat_lon: -75.2
            },
            goes16: {
                name: 'GOES-16',
                fullDiskUrl: 'https://cdn.star.nesdis.noaa.gov/GOES16/ABI/FD/GEOCOLOR/latest.jpg',
                sat_lon: -75.2
            }
        };
        
        // Par√¢metros da proje√ß√£o geoestacion√°ria (GOES-R PUG)
        const GOES_PARAMS = {
            sat_height: 35786023.0,  // metros
            r_eq: 6378137.0,         // metros
            r_pol: 6356752.31414,    // metros
            // Full Disk scan angles (aproximado para imagem completa)
            // O Full Disk cobre aproximadamente ¬±60¬∞ de latitude vis√≠vel
            scan_range: 0.151844    // radianos (aproximadamente ¬±8.7¬∞)
        };
        
        // Mapa e overlay
        let map;
        let satelliteOverlay = null;
        let currentBounds = null;
        
        // =====================================================
        // INICIALIZA√á√ÉO
        // =====================================================
        
        function initMap() {
            // Criar mapa centrado nas Am√©ricas
            map = L.map('map', {
                center: [-15, -60],
                zoom: 3,
                minZoom: 2,
                maxZoom: 10
            });
            
            // Camada base (mapa escuro)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap ¬© CartoDB'
            }).addTo(map);
            
            // Adicionar grid de refer√™ncia
            addReferenceGrid();
            
            // Eventos
            document.getElementById('opacitySlider').addEventListener('input', updateOpacity);
            document.getElementById('methodSelect').addEventListener('change', updateInfo);
            document.getElementById('satelliteSelect').addEventListener('change', updateInfo);
        }
        
        function addReferenceGrid() {
            // Linhas de latitude importantes
            const latLines = [-60, -30, 0, 30, 60];
            const lonLines = [-120, -90, -60, -30, 0];
            
            latLines.forEach(lat => {
                L.polyline([
                    [lat, -180],
                    [lat, 180]
                ], {
                    color: '#444',
                    weight: 1,
                    dashArray: '5, 5',
                    opacity: 0.5
                }).addTo(map);
                
                // Label
                L.marker([lat, -140], {
                    icon: L.divIcon({
                        className: 'grid-label',
                        html: `<span style="color:#666;font-size:10px;">${lat}¬∞</span>`,
                        iconSize: [30, 15]
                    })
                }).addTo(map);
            });
            
            lonLines.forEach(lon => {
                L.polyline([
                    [-80, lon],
                    [80, lon]
                ], {
                    color: '#444',
                    weight: 1,
                    dashArray: '5, 5',
                    opacity: 0.5
                }).addTo(map);
            });
        }
        
        // =====================================================
        // REPROJE√á√ÉO GEOESTACION√ÅRIA ‚Üí LAT/LON
        // =====================================================
        
        function scanToLatLon(x, y, sat_lon) {
            /**
             * Converte coordenadas de scan (radianos) para lat/lon.
             * Baseado no GOES-R Product User's Guide (PUG).
             */
            const H = GOES_PARAMS.sat_height + GOES_PARAMS.r_eq;
            const r_eq = GOES_PARAMS.r_eq;
            const r_pol = GOES_PARAMS.r_pol;
            
            const cos_x = Math.cos(x);
            const cos_y = Math.cos(y);
            const sin_x = Math.sin(x);
            const sin_y = Math.sin(y);
            
            // Fator de achatamento
            const f = (r_eq * r_eq) / (r_pol * r_pol);
            
            // C√°lculos intermedi√°rios
            const a = sin_x * sin_x + cos_x * cos_x * (cos_y * cos_y + f * sin_y * sin_y);
            const b = -2.0 * H * cos_x * cos_y;
            const c = H * H - r_eq * r_eq;
            
            const discriminant = b * b - 4.0 * a * c;
            
            if (discriminant < 0) {
                return null; // Ponto fora do disco vis√≠vel
            }
            
            const r_s = (-b - Math.sqrt(discriminant)) / (2.0 * a);
            
            const s_x = r_s * cos_x * cos_y;
            const s_y = -r_s * sin_x;
            const s_z = r_s * cos_x * sin_y;
            
            // Latitude geoc√™ntrica
            const lat_geo = Math.atan(f * s_z / Math.sqrt((H - s_x) * (H - s_x) + s_y * s_y));
            
            // Longitude
            const lon = sat_lon + Math.atan(s_y / (H - s_x)) * 180 / Math.PI;
            
            // Converter para graus
            const lat = lat_geo * 180 / Math.PI;
            
            return { lat, lon };
        }
        
        function calculateFullDiskBounds(sat_lon) {
            /**
             * Calcula os bounds da imagem Full Disk reprojetada.
             * Limita latitudes a ¬±70¬∞ para evitar distor√ß√µes extremas.
             */
            const scanRange = GOES_PARAMS.scan_range;
            
            // Testar pontos nas bordas da imagem para encontrar bounds reais
            let minLat = 90, maxLat = -90;
            let minLon = 180, maxLon = -180;
            
            // Amostrar a borda da imagem
            const steps = 100;
            for (let i = 0; i <= steps; i++) {
                const t = (i / steps) * 2 * Math.PI;
                const x = scanRange * Math.cos(t);
                const y = scanRange * Math.sin(t);
                
                const coords = scanToLatLon(x, y, sat_lon);
                if (coords) {
                    if (coords.lat < minLat) minLat = coords.lat;
                    if (coords.lat > maxLat) maxLat = coords.lat;
                    if (coords.lon < minLon) minLon = coords.lon;
                    if (coords.lon > maxLon) maxLon = coords.lon;
                }
            }
            
            // Centro da imagem
            const center = scanToLatLon(0, 0, sat_lon);
            if (center) {
                // O centro deve ter lon pr√≥ximo de sat_lon
            }
            
            // Limitar latitudes a ¬±70¬∞
            minLat = Math.max(minLat, -70);
            maxLat = Math.min(maxLat, 70);
            
            // Para Full Disk GOES, a cobertura √© aproximadamente:
            // Lat: -81¬∞ a +81¬∞ (limitamos a ¬±70¬∞)
            // Lon: sat_lon ¬± 81¬∞ (aproximadamente -156¬∞ a +6¬∞ para GOES-East)
            
            return {
                south: -70,
                north: 70,
                west: sat_lon - 75,  // Aproximadamente ¬±75¬∞ de longitude vis√≠vel
                east: sat_lon + 75
            };
        }
        
        // =====================================================
        // CARREGAMENTO DE IMAGEM
        // =====================================================
        
        async function loadFullDisk() {
            const satellite = document.getElementById('satelliteSelect').value;
            const method = document.getElementById('methodSelect').value;
            const satConfig = SATELLITES[satellite];
            
            showLoading('Carregando imagem Full Disk...');
            
            try {
                // Calcular bounds para reproje√ß√£o
                const bounds = calculateFullDiskBounds(satConfig.sat_lon);
                currentBounds = bounds;
                
                // Atualizar info
                document.getElementById('infoSatellite').textContent = satConfig.name;
                document.getElementById('infoMethod').textContent = method;
                document.getElementById('infoBoundsN').textContent = bounds.north.toFixed(1) + '¬∞';
                document.getElementById('infoBoundsS').textContent = bounds.south.toFixed(1) + '¬∞';
                document.getElementById('infoBoundsW').textContent = bounds.west.toFixed(1) + '¬∞';
                document.getElementById('infoBoundsE').textContent = bounds.east.toFixed(1) + '¬∞';
                
                // Remover overlay anterior
                if (satelliteOverlay) {
                    map.removeLayer(satelliteOverlay);
                }
                
                // Carregar imagem diretamente do NOAA
                const imgUrl = satConfig.fullDiskUrl + '?t=' + Date.now();
                
                // Criar bounds para Leaflet
                const leafletBounds = [
                    [bounds.south, bounds.west],
                    [bounds.north, bounds.east]
                ];
                
                // Criar overlay
                satelliteOverlay = L.imageOverlay(imgUrl, leafletBounds, {
                    opacity: document.getElementById('opacitySlider').value / 100,
                    crossOrigin: 'anonymous'
                });
                
                // Esperar imagem carregar
                await new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = imgUrl;
                });
                
                satelliteOverlay.addTo(map);
                
                // Ajustar vis√£o
                map.fitBounds(leafletBounds);
                
                // Atualizar status
                document.getElementById('infoStatus').textContent = 'Carregado';
                document.getElementById('infoStatus').className = 'info-value success';
                document.getElementById('statusText').textContent = `${satConfig.name} Full Disk carregado`;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
                hideLoading();
                
            } catch (error) {
                console.error('Erro ao carregar imagem:', error);
                document.getElementById('infoStatus').textContent = 'Erro!';
                document.getElementById('infoStatus').className = 'info-value error';
                document.getElementById('statusText').textContent = 'Erro: ' + error.message;
                hideLoading();
            }
        }
        
        async function reprocessImage() {
            // Por enquanto, apenas recarrega
            // TODO: Implementar chamada para backend de reproje√ß√£o
            const method = document.getElementById('methodSelect').value;
            alert(`Reproje√ß√£o com m√©todo "${method}" ser√° implementada no backend.\n\nPor enquanto, a imagem √© carregada diretamente do NOAA com bounds calculados.`);
        }
        
        // =====================================================
        // UTILIDADES
        // =====================================================
        
        function updateOpacity() {
            const value = document.getElementById('opacitySlider').value;
            document.getElementById('opacityValue').textContent = value + '%';
            if (satelliteOverlay) {
                satelliteOverlay.setOpacity(value / 100);
            }
        }
        
        function updateInfo() {
            const satellite = document.getElementById('satelliteSelect').value;
            const method = document.getElementById('methodSelect').value;
            document.getElementById('infoSatellite').textContent = SATELLITES[satellite].name;
            document.getElementById('infoMethod').textContent = method;
        }
        
        function fitToBounds() {
            if (currentBounds) {
                map.fitBounds([
                    [currentBounds.south, currentBounds.west],
                    [currentBounds.north, currentBounds.east]
                ]);
            }
        }
        
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        // =====================================================
        // INICIALIZA√á√ÉO
        // =====================================================
        
        initMap();
    </script>
</body>
</html>
