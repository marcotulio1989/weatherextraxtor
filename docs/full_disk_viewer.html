<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ∞Ô∏è GOES Satellite Viewer - Imagem Completa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(90deg, #1a1a2e, #16213e);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #00d4ff;
        }
        .header h1 { color: #00d4ff; font-size: 1.2em; }
        
        .controls {
            background: rgba(0,0,0,0.85);
            padding: 10px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid #333;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .control-group label {
            font-size: 0.7em;
            color: #888;
            text-transform: uppercase;
        }
        select, button {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #444;
            background: #1a1a2e;
            color: #e0e0e0;
            font-size: 0.85em;
            cursor: pointer;
        }
        button {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
            font-weight: bold;
            border: none;
        }
        button:hover { box-shadow: 0 3px 10px rgba(0,212,255,0.4); }
        button:disabled { opacity: 0.5; cursor: wait; }
        
        .slider-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .slider-group input { width: 100px; }
        .slider-value { color: #00d4ff; font-weight: bold; min-width: 40px; }
        
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; background: #111; }
        
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8em;
            z-index: 1000;
            min-width: 200px;
            border: 1px solid #333;
        }
        .info-panel h3 { color: #00d4ff; margin-bottom: 8px; font-size: 0.9em; }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .info-label { color: #666; }
        .info-value { color: #00d4ff; }
        .info-value.ok { color: #2ecc71; }
        .info-value.err { color: #e74c3c; }
        
        .loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 30px 50px;
            border-radius: 10px;
            z-index: 9999;
            text-align: center;
        }
        .loading.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #333;
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .progress { margin-top: 10px; }
        .progress-bar {
            width: 200px; height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #00d4ff;
            width: 0%;
        }
        .progress-text { margin-top: 5px; font-size: 0.8em; color: #888; }
        
        .status-bar {
            background: #111;
            padding: 8px 20px;
            font-size: 0.75em;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üõ∞Ô∏è GOES Satellite - Imagem Completa</h1>
        <span style="color:#888; font-size:0.85em;">Reproje√ß√£o em tempo real no browser</span>
    </header>
    
    <div class="controls">
        <div class="control-group">
            <label>üõ∞Ô∏è Sat√©lite</label>
            <select id="satellite">
                <option value="goes19">GOES-19</option>
                <option value="goes16">GOES-16</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>üì∑ Tipo de Imagem</label>
            <select id="imageType">
                <option value="ssa">SSA (Am√©rica do Sul)</option>
                <option value="fd">Full Disk (Disco Completo)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>üîß M√©todo de Reproje√ß√£o</label>
            <select id="method">
                <option value="direct">Direto (Bounds Aproximados)</option>
                <option value="manual">Manual (Pixel a Pixel)</option>
                <option value="bilinear">Bilinear (Suavizado)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>üîç Opacidade</label>
            <div class="slider-group">
                <input type="range" id="opacity" min="0" max="100" value="75">
                <span class="slider-value" id="opacityVal">75%</span>
            </div>
        </div>
        
        <button id="loadBtn" onclick="loadImage()">üåç CARREGAR IMAGEM</button>
        <button onclick="fitBounds()">üìç Ver Tudo</button>
        <button onclick="zoomShip()">üö¢ Ir ao Navio</button>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
        
        <div class="info-panel">
            <h3>üìä Status</h3>
            <div class="info-row">
                <span class="info-label">Sat√©lite:</span>
                <span class="info-value" id="infoSat">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Tipo:</span>
                <span class="info-value" id="infoType">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">M√©todo:</span>
                <span class="info-value" id="infoMethod">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Status:</span>
                <span class="info-value" id="infoStatus">Aguardando</span>
            </div>
            <div class="info-row">
                <span class="info-label">Lat Norte:</span>
                <span class="info-value" id="infoN">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Lat Sul:</span>
                <span class="info-value" id="infoS">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Lon Oeste:</span>
                <span class="info-value" id="infoW">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Lon Leste:</span>
                <span class="info-value" id="infoE">-</span>
            </div>
        </div>
        
        <div class="loading hidden" id="loading">
            <div class="spinner"></div>
            <div id="loadingText">Carregando...</div>
            <div class="progress">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <span id="statusText">Pronto</span>
        <span id="timestamp">-</span>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // =========================================================
        // CONFIGURA√á√ÉO
        // =========================================================
        
        const SHIP = { lat: -22.5, lon: -40.5 };
        
        // URLs das imagens NOAA
        const IMAGES = {
            goes19: {
                ssa: 'https://cdn.star.nesdis.noaa.gov/GOES19/ABI/SECTOR/ssa/GEOCOLOR/latest.jpg',
                fd: 'https://cdn.star.nesdis.noaa.gov/GOES19/ABI/FD/GEOCOLOR/latest.jpg'
            },
            goes16: {
                ssa: 'https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/ssa/GEOCOLOR/latest.jpg',
                fd: 'https://cdn.star.nesdis.noaa.gov/GOES16/ABI/FD/GEOCOLOR/latest.jpg'
            }
        };
        
        // Bounds de sa√≠da para reproje√ß√£o
        // GOES-East est√° em -75.2¬∞ de longitude
        // Visibilidade: aproximadamente ¬±75¬∞ do ponto subsat√©lite
        const BOUNDS = {
            ssa: {
                // Bounds da imagem SSA calibrados
                north: 17,
                south: -82,
                west: -115,
                east: -15
            },
            fd: {
                // Full Disk focado na Am√©rica do Sul
                // Latitude: 0¬∞ a -55¬∞
                north: 0,
                south: -55,
                west: -90,
                east: -25
            }
        };
        
        let map, overlay = null;
        
        // =========================================================
        // INICIALIZA√á√ÉO
        // =========================================================
        
        function init() {
            map = L.map('map', {
                center: [-20, -50],
                zoom: 4,
                minZoom: 2,
                maxZoom: 10
            });
            
            // Mapa base
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);
            
            // Grid de refer√™ncia
            addGrid();
            
            // Marcador do navio
            addShipMarker();
            
            // Eventos
            document.getElementById('opacity').addEventListener('input', updateOpacity);
        }
        
        function addGrid() {
            // Linhas de latitude
            for (let lat = -60; lat <= 60; lat += 10) {
                L.polyline([[lat, -180], [lat, 180]], {
                    color: lat === 0 ? '#f80' : '#444',
                    weight: lat % 30 === 0 ? 1 : 0.5,
                    opacity: 0.5
                }).addTo(map);
            }
            // Linhas de longitude
            for (let lon = -180; lon <= 180; lon += 10) {
                L.polyline([[-80, lon], [80, lon]], {
                    color: lon === 0 ? '#f80' : '#444',
                    weight: lon % 30 === 0 ? 1 : 0.5,
                    opacity: 0.5
                }).addTo(map);
            }
        }
        
        function addShipMarker() {
            const icon = L.divIcon({
                html: '<div style="font-size:24px;filter:drop-shadow(0 0 5px #0ff);">üö¢</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            L.marker([SHIP.lat, SHIP.lon], { icon }).addTo(map)
                .bindPopup(`<b>Deepwater Aquila</b><br>${SHIP.lat}¬∞, ${SHIP.lon}¬∞`);
            
            // C√≠rculo de 100 NM
            L.circle([SHIP.lat, SHIP.lon], {
                radius: 100 * 1852,
                color: '#0ff',
                fillOpacity: 0.05,
                weight: 2,
                dashArray: '5,5'
            }).addTo(map);
        }
        
        // =========================================================
        // CARREGAMENTO DE IMAGEM
        // =========================================================
        
        async function loadImage() {
            const sat = document.getElementById('satellite').value;
            const type = document.getElementById('imageType').value;
            const method = document.getElementById('method').value;
            
            const btn = document.getElementById('loadBtn');
            btn.disabled = true;
            
            showLoading('Baixando imagem do NOAA...');
            setProgress(10);
            
            try {
                const url = IMAGES[sat][type];
                const bounds = BOUNDS[type];
                
                // Atualizar info
                document.getElementById('infoSat').textContent = sat.toUpperCase();
                document.getElementById('infoType').textContent = type.toUpperCase();
                document.getElementById('infoMethod').textContent = method;
                
                // Remover overlay anterior
                if (overlay) map.removeLayer(overlay);
                
                setProgress(30);
                showLoading('Processando imagem...');
                
                if (method === 'direct') {
                    // M√©todo direto: usa bounds aproximados
                    await loadDirect(url, bounds);
                } else {
                    // Reproje√ß√£o no browser
                    await loadWithReprojection(url, bounds, type, sat, method);
                }
                
                // Atualizar bounds no painel
                document.getElementById('infoN').textContent = bounds.north + '¬∞';
                document.getElementById('infoS').textContent = bounds.south + '¬∞';
                document.getElementById('infoW').textContent = bounds.west + '¬∞';
                document.getElementById('infoE').textContent = bounds.east + '¬∞';
                
                document.getElementById('infoStatus').textContent = 'OK';
                document.getElementById('infoStatus').className = 'info-value ok';
                document.getElementById('statusText').textContent = 'Imagem carregada com sucesso';
                document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
                
                setProgress(100);
                setTimeout(hideLoading, 300);
                
            } catch (err) {
                console.error(err);
                document.getElementById('infoStatus').textContent = 'ERRO';
                document.getElementById('infoStatus').className = 'info-value err';
                document.getElementById('statusText').textContent = 'Erro: ' + err.message;
                hideLoading();
            }
            
            btn.disabled = false;
        }
        
        async function loadDirect(url, bounds) {
            // Carregar imagem diretamente com bounds aproximados
            const leafletBounds = [[bounds.south, bounds.west], [bounds.north, bounds.east]];
            
            overlay = L.imageOverlay(url + '?t=' + Date.now(), leafletBounds, {
                opacity: document.getElementById('opacity').value / 100,
                crossOrigin: 'anonymous'
            }).addTo(map);
            
            setProgress(90);
        }
        
        async function loadWithReprojection(url, bounds, type, sat, method) {
            // Carregar imagem
            const img = await loadImg(url + '?t=' + Date.now());
            setProgress(50);
            
            showLoading('Reprojetando...');
            
            // Criar canvas de sa√≠da
            const outWidth = 1800;  // Largura fixa para boa qualidade
            const outHeight = Math.round(outWidth * (bounds.north - bounds.south) / (bounds.east - bounds.west));
            
            const canvas = document.createElement('canvas');
            canvas.width = outWidth;
            canvas.height = outHeight;
            const ctx = canvas.getContext('2d');
            
            // Canvas fonte
            const srcCanvas = document.createElement('canvas');
            srcCanvas.width = img.width;
            srcCanvas.height = img.height;
            const srcCtx = srcCanvas.getContext('2d');
            srcCtx.drawImage(img, 0, 0);
            const srcData = srcCtx.getImageData(0, 0, img.width, img.height);
            
            // Canvas destino
            const outData = ctx.createImageData(outWidth, outHeight);
            
            // Par√¢metros de reproje√ß√£o
            const sat_lon = -75.2; // Longitude do GOES-East
            
            // Processar pixel a pixel
            for (let y = 0; y < outHeight; y++) {
                for (let x = 0; x < outWidth; x++) {
                    // Lat/lon do pixel de sa√≠da
                    const lon = bounds.west + (x / outWidth) * (bounds.east - bounds.west);
                    const lat = bounds.north - (y / outHeight) * (bounds.north - bounds.south);
                    
                    // Calcular posi√ß√£o na imagem fonte
                    let srcX, srcY;
                    
                    if (type === 'ssa') {
                        // Para SSA, mapeamento direto
                        // Imagem SSA: x=0 √© oeste, y=0 √© norte
                        srcX = ((lon - bounds.west) / (bounds.east - bounds.west)) * img.width;
                        srcY = ((bounds.north - lat) / (bounds.north - bounds.south)) * img.height;
                    } else {
                        // Para Full Disk, usar proje√ß√£o geoestacion√°ria
                        const scan = latLonToScan(lat, lon, sat_lon);
                        if (!scan) {
                            const idx = (y * outWidth + x) * 4;
                            outData.data[idx + 3] = 0; // Transparente
                            continue;
                        }
                        // Full Disk NOAA:
                        // - Imagem quadrada com Terra no centro
                        // - y=0 √© o NORTE (topo), y=max √© o SUL (fundo)
                        // - x=0 √© o OESTE (esquerda), x=max √© o LESTE (direita)
                        // scan.x: negativo=oeste, positivo=leste
                        // scan.y: negativo=sul, positivo=norte
                        srcX = ((scan.x + 0.151844) / (2 * 0.151844)) * img.width;
                        srcY = ((0.151844 - scan.y) / (2 * 0.151844)) * img.height;
                    }
                    
                    if (srcX < 0 || srcX >= img.width || srcY < 0 || srcY >= img.height) {
                        continue;
                    }
                    
                    const idx = (y * outWidth + x) * 4;
                    
                    if (method === 'bilinear') {
                        // Interpola√ß√£o bilinear
                        const color = bilinear(srcData, srcX, srcY);
                        outData.data[idx] = color.r;
                        outData.data[idx + 1] = color.g;
                        outData.data[idx + 2] = color.b;
                        outData.data[idx + 3] = 255;
                    } else {
                        // Nearest neighbor
                        const sx = Math.floor(srcX);
                        const sy = Math.floor(srcY);
                        const srcIdx = (sy * img.width + sx) * 4;
                        outData.data[idx] = srcData.data[srcIdx];
                        outData.data[idx + 1] = srcData.data[srcIdx + 1];
                        outData.data[idx + 2] = srcData.data[srcIdx + 2];
                        outData.data[idx + 3] = 255;
                    }
                }
                
                // Atualizar progresso
                if (y % 50 === 0) {
                    setProgress(50 + (y / outHeight) * 40);
                    await sleep(0);
                }
            }
            
            ctx.putImageData(outData, 0, 0);
            
            // Criar overlay
            const dataUrl = canvas.toDataURL('image/png');
            const leafletBounds = [[bounds.south, bounds.west], [bounds.north, bounds.east]];
            
            overlay = L.imageOverlay(dataUrl, leafletBounds, {
                opacity: document.getElementById('opacity').value / 100
            }).addTo(map);
        }
        
        // =========================================================
        // FUN√á√ïES DE PROJE√á√ÉO
        // =========================================================
        
        function latLonToScan(lat, lon, sat_lon) {
            // Converte lat/lon para coordenadas de scan do GOES
            // Baseado no GOES-R PUG (Product User's Guide)
            const H = 42164160.0;  // Dist√¢ncia sat√©lite-centro da Terra (m)
            const r_eq = 6378137.0;
            const r_pol = 6356752.31414;
            
            const lat_rad = lat * Math.PI / 180;
            const lon_rad = (lon - sat_lon) * Math.PI / 180;
            
            const cos_lat = Math.cos(lat_rad);
            const sin_lat = Math.sin(lat_rad);
            
            // Raio geoc√™ntrico
            const r_geo = r_eq * r_pol / Math.sqrt(
                r_pol * r_pol * cos_lat * cos_lat + 
                r_eq * r_eq * sin_lat * sin_lat
            );
            
            // Vetor do sat√©lite ao ponto na Terra
            const r_1 = H - r_geo * cos_lat * Math.cos(lon_rad);
            const r_2 = -r_geo * cos_lat * Math.sin(lon_rad);
            const r_3 = r_geo * sin_lat;
            
            // Verificar se ponto est√° vis√≠vel
            if (r_1 > H) return null;
            
            const r_n = Math.sqrt(r_1*r_1 + r_2*r_2 + r_3*r_3);
            
            // Coordenadas de scan
            // x: √¢ngulo leste-oeste (positivo = leste)
            // y: √¢ngulo norte-sul (positivo = norte na nossa conven√ß√£o)
            const x = Math.atan2(-r_2, r_1);
            const y = Math.asin(r_3 / r_n);  // CORRIGIDO: sem negativo
            
            if (Math.abs(x) > 0.151844 || Math.abs(y) > 0.151844) return null;
            
            return { x, y };
        }
        
        function bilinear(srcData, x, y) {
            const x0 = Math.floor(x);
            const y0 = Math.floor(y);
            const x1 = Math.min(x0 + 1, srcData.width - 1);
            const y1 = Math.min(y0 + 1, srcData.height - 1);
            
            const fx = x - x0;
            const fy = y - y0;
            
            const w00 = (1 - fx) * (1 - fy);
            const w10 = fx * (1 - fy);
            const w01 = (1 - fx) * fy;
            const w11 = fx * fy;
            
            const i00 = (y0 * srcData.width + x0) * 4;
            const i10 = (y0 * srcData.width + x1) * 4;
            const i01 = (y1 * srcData.width + x0) * 4;
            const i11 = (y1 * srcData.width + x1) * 4;
            
            return {
                r: Math.round(srcData.data[i00] * w00 + srcData.data[i10] * w10 + srcData.data[i01] * w01 + srcData.data[i11] * w11),
                g: Math.round(srcData.data[i00+1] * w00 + srcData.data[i10+1] * w10 + srcData.data[i01+1] * w01 + srcData.data[i11+1] * w11),
                b: Math.round(srcData.data[i00+2] * w00 + srcData.data[i10+2] * w10 + srcData.data[i01+2] * w01 + srcData.data[i11+2] * w11)
            };
        }
        
        // =========================================================
        // UTILIDADES
        // =========================================================
        
        function loadImg(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Falha ao carregar imagem'));
                img.src = url;
            });
        }
        
        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
        
        function updateOpacity() {
            const v = document.getElementById('opacity').value;
            document.getElementById('opacityVal').textContent = v + '%';
            if (overlay) overlay.setOpacity(v / 100);
        }
        
        function fitBounds() {
            const type = document.getElementById('imageType').value;
            const b = BOUNDS[type];
            map.fitBounds([[b.south, b.west], [b.north, b.east]]);
        }
        
        function zoomShip() {
            map.setView([SHIP.lat, SHIP.lon], 6);
        }
        
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loading').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        function setProgress(pct) {
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('progressText').textContent = Math.round(pct) + '%';
        }
        
        // =========================================================
        // INIT
        // =========================================================
        
        init();
    </script>
</body>
</html>
