<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ∞Ô∏è Satellite Viewer - M√©todos de Reproje√ß√£o</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(90deg, #1a1a2e, #16213e);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #00d4ff;
            flex-shrink: 0;
        }
        .header h1 { color: #00d4ff; font-size: 1.4em; }
        
        .controls {
            background: rgba(0,0,0,0.8);
            padding: 12px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
            border-bottom: 1px solid #333;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .control-group label {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            font-weight: bold;
        }
        select, button {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #1a1a2e;
            color: #e0e0e0;
            font-size: 0.95em;
            cursor: pointer;
            min-width: 180px;
        }
        select:focus { outline: none; border-color: #00d4ff; }
        
        button {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
            font-weight: bold;
            border: none;
            min-width: 150px;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,212,255,0.4);
        }
        button.secondary {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        button.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .opacity-slider {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .opacity-slider input { width: 120px; }
        .opacity-value { 
            color: #00d4ff; 
            font-weight: bold; 
            min-width: 45px;
            text-align: center;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        #map { width: 100%; height: 100%; }
        
        /* Info Panel */
        .info-panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.92);
            padding: 15px 18px;
            border-radius: 10px;
            font-size: 0.85em;
            z-index: 1000;
            min-width: 260px;
            border: 1px solid #333;
        }
        .info-panel h3 {
            color: #00d4ff;
            margin-bottom: 12px;
            font-size: 1em;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #888; }
        .info-value { color: #00d4ff; font-weight: bold; }
        .info-value.success { color: #2ecc71; }
        .info-value.error { color: #e74c3c; }
        .info-value.warning { color: #f39c12; }
        
        /* Status Bar */
        .status-bar {
            background: rgba(0,0,0,0.9);
            padding: 10px 20px;
            font-size: 0.85em;
            color: #888;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
            border-top: 1px solid #333;
        }
        .status-bar .status-ok { color: #2ecc71; }
        .status-bar .status-error { color: #e74c3c; }
        
        /* Loading */
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Method comparison badges */
        .method-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
        }
        .method-badge.manual { background: #3498db; color: #fff; }
        .method-badge.gdal { background: #9b59b6; color: #fff; }
        .method-badge.cartopy { background: #2ecc71; color: #fff; }
        .method-badge.satpy { background: #e74c3c; color: #fff; }
    </style>
</head>
<body>
    <header class="header">
        <h1>üõ∞Ô∏è Satellite Image Viewer</h1>
        <div style="color: #888; font-size: 0.9em;">
            Compara√ß√£o de M√©todos de Reproje√ß√£o
        </div>
    </header>
    
    <div class="controls">
        <div class="control-group">
            <label>üõ∞Ô∏è Sat√©lite</label>
            <select id="satelliteSelect">
                <option value="goes19">GOES-19 (East)</option>
                <option value="goes16">GOES-16 (East)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>üîß M√©todo de Reproje√ß√£o</label>
            <select id="methodSelect">
                <option value="manual">Manual (Matem√°tica Pura)</option>
                <option value="gdal">GDAL (rasterio + pyproj)</option>
                <option value="cartopy">Cartopy (matplotlib)</option>
                <option value="satpy">SatPy (pyresample)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>üîç Opacidade da Imagem</label>
            <div class="opacity-slider">
                <input type="range" id="opacitySlider" min="0" max="100" value="80">
                <span class="opacity-value" id="opacityValue">80%</span>
            </div>
        </div>
        
        <button onclick="loadSatelliteImage()">
            üîÑ Carregar Imagem
        </button>
        
        <button class="secondary" onclick="zoomToShip()">
            üìç Ir para Navio
        </button>
        
        <button class="danger" onclick="runReprojection()">
            ‚ö° Executar Reproje√ß√£o
        </button>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
        
        <div class="info-panel">
            <h3>üìä Informa√ß√µes da Imagem</h3>
            <div class="info-row">
                <span class="info-label">Sat√©lite:</span>
                <span class="info-value" id="infoSatellite">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">M√©todo:</span>
                <span class="info-value" id="infoMethod">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Status:</span>
                <span class="info-value" id="infoStatus">Aguardando...</span>
            </div>
            <div class="info-row">
                <span class="info-label">√öltima Atualiza√ß√£o:</span>
                <span class="info-value" id="infoTime">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Bounds N:</span>
                <span class="info-value" id="infoBoundsN">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Bounds S:</span>
                <span class="info-value" id="infoBoundsS">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Bounds W:</span>
                <span class="info-value" id="infoBoundsW">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Bounds E:</span>
                <span class="info-value" id="infoBoundsE">-</span>
            </div>
        </div>
        
        <div class="loading-overlay hidden" id="loadingOverlay">
            <div class="spinner"></div>
            <div id="loadingText">Carregando...</div>
        </div>
    </div>
    
    <div class="status-bar">
        <span id="statusText">Pronto</span>
        <span id="lastUpdate">-</span>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // =====================================================
        // CONFIGURA√á√ÉO
        // =====================================================
        
        const SHIP_LAT = -22.5;
        const SHIP_LON = -40.5;
        const RADIUS_NM = 100;
        
        let map;
        let satelliteOverlay = null;
        let shipMarker = null;
        let radiusCircle = null;
        
        // =====================================================
        // INICIALIZA√á√ÉO
        // =====================================================
        
        function initMap() {
            map = L.map('map', {
                center: [SHIP_LAT, SHIP_LON],
                zoom: 6,
                minZoom: 3,
                maxZoom: 12
            });
            
            // Mapa base escuro
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '¬© CartoDB ¬© OpenStreetMap'
            }).addTo(map);
            
            // Adicionar marcador do navio
            addShipMarker();
            
            // Adicionar c√≠rculo de raio
            addRadiusCircle();
            
            // Eventos
            document.getElementById('opacitySlider').addEventListener('input', updateOpacity);
            document.getElementById('satelliteSelect').addEventListener('change', loadSatelliteImage);
            document.getElementById('methodSelect').addEventListener('change', loadSatelliteImage);
            
            // Carregar imagem inicial
            loadSatelliteImage();
        }
        
        function addShipMarker() {
            const shipIcon = L.divIcon({
                className: 'ship-icon',
                html: `<svg viewBox="0 0 24 24" width="32" height="32" style="filter: drop-shadow(0 0 6px #00ffcc);">
                    <polygon points="12,2 22,22 12,18 2,22" fill="#00ffcc" stroke="#000" stroke-width="1"/>
                </svg>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            shipMarker = L.marker([SHIP_LAT, SHIP_LON], { icon: shipIcon })
                .addTo(map)
                .bindPopup(`<b>Deepwater Aquila</b><br>Lat: ${SHIP_LAT}¬∞<br>Lon: ${SHIP_LON}¬∞`);
        }
        
        function addRadiusCircle() {
            radiusCircle = L.circle([SHIP_LAT, SHIP_LON], {
                radius: RADIUS_NM * 1852, // NM para metros
                color: '#00ffcc',
                fillColor: '#00ffcc',
                fillOpacity: 0.05,
                weight: 2,
                dashArray: '10, 5'
            }).addTo(map);
        }
        
        // =====================================================
        // CARREGAMENTO DE IMAGEM
        // =====================================================
        
        async function loadSatelliteImage() {
            const satellite = document.getElementById('satelliteSelect').value;
            const method = document.getElementById('methodSelect').value;
            
            showLoading('Carregando imagem...');
            
            try {
                // Construir nome do arquivo baseado no m√©todo
                let imgFile, jsonFile;
                
                if (method === 'manual') {
                    imgFile = `satellite_${satellite}.png`;
                    jsonFile = `satellite_${satellite}.json`;
                } else {
                    imgFile = `satellite_${satellite}_${method}.png`;
                    jsonFile = `satellite_${satellite}_${method}.json`;
                }
                
                // Carregar JSON com metadados
                const jsonUrl = jsonFile + '?t=' + Date.now();
                const response = await fetch(jsonUrl);
                
                if (!response.ok) {
                    throw new Error(`Imagem n√£o encontrada: ${jsonFile}`);
                }
                
                const data = await response.json();
                
                // Remover overlay anterior
                if (satelliteOverlay) {
                    map.removeLayer(satelliteOverlay);
                }
                
                // Adicionar novo overlay
                const imgUrl = imgFile + '?t=' + Date.now();
                const bounds = data.leaflet_bounds;
                
                satelliteOverlay = L.imageOverlay(imgUrl, bounds, {
                    opacity: document.getElementById('opacitySlider').value / 100
                }).addTo(map);
                
                // Atualizar informa√ß√µes
                document.getElementById('infoSatellite').textContent = data.satellite_name || satellite.toUpperCase();
                document.getElementById('infoMethod').innerHTML = `<span class="method-badge ${method}">${method}</span>`;
                document.getElementById('infoStatus').textContent = 'Carregado';
                document.getElementById('infoStatus').className = 'info-value success';
                document.getElementById('infoTime').textContent = data.image_time_utc || '-';
                
                if (data.bounds) {
                    document.getElementById('infoBoundsN').textContent = data.bounds.lat_max.toFixed(2) + '¬∞';
                    document.getElementById('infoBoundsS').textContent = data.bounds.lat_min.toFixed(2) + '¬∞';
                    document.getElementById('infoBoundsW').textContent = data.bounds.lon_min.toFixed(2) + '¬∞';
                    document.getElementById('infoBoundsE').textContent = data.bounds.lon_max.toFixed(2) + '¬∞';
                }
                
                document.getElementById('statusText').innerHTML = `<span class="status-ok">‚úì</span> Imagem carregada: ${imgFile}`;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
                hideLoading();
                
            } catch (error) {
                console.error('Erro:', error);
                
                document.getElementById('infoStatus').textContent = 'N√£o dispon√≠vel';
                document.getElementById('infoStatus').className = 'info-value error';
                document.getElementById('statusText').innerHTML = `<span class="status-error">‚úó</span> ${error.message}`;
                
                hideLoading();
            }
        }
        
        async function runReprojection() {
            const satellite = document.getElementById('satelliteSelect').value;
            const method = document.getElementById('methodSelect').value;
            
            // Mostrar instru√ß√µes para rodar o backend
            const cmd = `python satellite_reprojector.py --satellite ${satellite} --method ${method}`;
            
            alert(`Para gerar uma nova imagem reprojetada, execute no terminal:\n\n${cmd}\n\nAp√≥s a execu√ß√£o, clique em "Carregar Imagem" para visualizar.`);
        }
        
        // =====================================================
        // UTILIDADES
        // =====================================================
        
        function updateOpacity() {
            const value = document.getElementById('opacitySlider').value;
            document.getElementById('opacityValue').textContent = value + '%';
            
            if (satelliteOverlay) {
                satelliteOverlay.setOpacity(value / 100);
            }
        }
        
        function zoomToShip() {
            map.setView([SHIP_LAT, SHIP_LON], 7);
        }
        
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        // =====================================================
        // INIT
        // =====================================================
        
        initMap();
    </script>
</body>
</html>
