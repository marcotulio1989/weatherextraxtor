<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ∞Ô∏è Alinhamento V6 - Malha com Exclus√£o</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a15;
            color: #eee;
            overflow: hidden;
        }
        .container { display: flex; height: 100vh; }
        
        .control-panel {
            width: 340px;
            background: linear-gradient(180deg, #16213e 0%, #1a1a2e 100%);
            padding: 12px;
            overflow-y: auto;
            border-right: 2px solid #0f3460;
            z-index: 1000;
            flex-shrink: 0;
        }
        .control-panel h1 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #e94560;
            text-align: center;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 8px;
        }
        .control-section {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(15, 52, 96, 0.5);
            border-radius: 8px;
        }
        .control-section h3 {
            color: #00d9ff;
            margin-bottom: 8px;
            font-size: 0.8em;
        }
        .btn {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, #e94560, #c23a51); color: white; }
        .btn-secondary { background: #0f3460; color: #00d9ff; border: 1px solid #00d9ff; }
        .btn-success { background: linear-gradient(135deg, #00b894, #00a381); color: white; }
        .btn-warning { background: linear-gradient(135deg, #fdcb6e, #e17055); color: #1a1a2e; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.3); }
        .btn.active { background: #ff00ff !important; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255,0,255,0.5); }
            50% { box-shadow: 0 0 15px rgba(255,0,255,0.8); }
        }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .btn-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; }
        
        #map { flex: 1; background: #1a1a2e; position: relative; }
        
        .slider-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 6px;
        }
        .slider-row label {
            width: 65px;
            font-size: 0.7em;
            color: #aaa;
        }
        .slider-row input[type="range"] {
            flex: 1;
            height: 5px;
            border-radius: 3px;
            background: #0f3460;
            outline: none;
            -webkit-appearance: none;
        }
        .slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00d9ff;
            cursor: pointer;
        }
        .slider-row .value {
            width: 45px;
            font-size: 0.7em;
            color: #00ff00;
            text-align: right;
            font-family: monospace;
        }
        
        .status-bar {
            font-size: 0.75em;
            color: #888;
            padding: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            margin-top: 6px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0; top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%; height: 100%;
        }
        
        .instructions {
            font-size: 0.7em;
            color: #888;
            line-height: 1.4;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            border-left: 2px solid #00d9ff;
        }
        
        .triangle-list {
            max-height: 120px;
            overflow-y: auto;
            background: #0a0a15;
            padding: 4px;
            border-radius: 4px;
            margin-top: 6px;
        }
        .triangle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 6px;
            margin-bottom: 3px;
            background: rgba(255,0,0,0.2);
            border-radius: 3px;
            font-size: 0.7em;
            border-left: 3px solid #e74c3c;
        }
        .triangle-item button {
            background: #00b894;
            border: none;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        /* Marcador de ponto */
        .control-point {
            width: 16px;
            height: 16px;
            background: #ff00ff;
            border: 2px solid white;
            border-radius: 50%;
            cursor: move;
            box-shadow: 0 0 8px rgba(255,0,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: white;
        }
        .control-point.corner { background: #00ff00; }
        
        /* Canvas overlay */
        #imageCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 400;
        }
        
        /* Overlay para sele√ß√£o de tri√¢ngulos */
        #selectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 450;
        }
        
        .delete-mode-active {
            border: 3px solid #e74c3c !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="control-panel">
            <h1>üõ∞Ô∏è Alinhamento V6</h1>

            <!-- Carregar Imagem -->
            <div class="control-section">
                <h3>üìÅ Imagem</h3>
                <div class="btn-grid">
                    <button class="btn btn-primary" onclick="loadNoaaImage('goes19')" style="font-size:0.7em;">üõ∞Ô∏è GOES-19</button>
                    <button class="btn btn-primary" onclick="loadNoaaImage('goes16')" style="font-size:0.7em; background:#3498db;">üõ∞Ô∏è GOES-16</button>
                </div>
                <div class="file-input-wrapper">
                    <button class="btn btn-secondary">üìÇ Arquivo</button>
                    <input type="file" id="imageInput" accept="image/*">
                </div>
                <div class="status-bar" id="imageStatus">Nenhuma imagem</div>
            </div>

            <!-- Grade -->
            <div class="control-section">
                <h3>üìê Grade de Pontos</h3>
                <div class="btn-grid-3">
                    <button class="btn btn-secondary" onclick="setGrid(2,2)" style="font-size:0.7em;">2√ó2</button>
                    <button class="btn btn-secondary" onclick="setGrid(3,3)" style="font-size:0.7em;">3√ó3</button>
                    <button class="btn btn-secondary" onclick="setGrid(4,4)" style="font-size:0.7em;">4√ó4</button>
                    <button class="btn btn-secondary" onclick="setGrid(5,5)" style="font-size:0.7em;">5√ó5</button>
                    <button class="btn btn-secondary" onclick="setGrid(6,6)" style="font-size:0.7em;">6√ó6</button>
                    <button class="btn btn-secondary" onclick="setGrid(4,6)" style="font-size:0.7em;">4√ó6</button>
                </div>
                <div class="status-bar">Pontos: <span id="pointCount">0</span> | Tri√¢ngulos: <span id="triangleCount">0</span></div>
            </div>

            <!-- Transforma√ß√µes -->
            <div class="control-section">
                <h3>üîß Transforma√ß√µes Globais</h3>
                <div class="slider-row">
                    <label>Escala X:</label>
                    <input type="range" id="scaleX" min="0.2" max="2" step="0.01" value="1" oninput="updateAll()">
                    <span class="value" id="scaleXVal">1.00</span>
                </div>
                <div class="slider-row">
                    <label>Escala Y:</label>
                    <input type="range" id="scaleY" min="0.2" max="2" step="0.01" value="1" oninput="updateAll()">
                    <span class="value" id="scaleYVal">1.00</span>
                </div>
                <div class="slider-row">
                    <label>Rota√ß√£o:</label>
                    <input type="range" id="rotation" min="-45" max="45" step="0.5" value="0" oninput="updateAll()">
                    <span class="value" id="rotationVal">0¬∞</span>
                </div>
                <div class="slider-row">
                    <label>Cisalha X:</label>
                    <input type="range" id="skewX" min="-30" max="30" step="0.5" value="0" oninput="updateAll()">
                    <span class="value" id="skewXVal">0¬∞</span>
                </div>
                <div class="slider-row">
                    <label>Cisalha Y:</label>
                    <input type="range" id="skewY" min="-30" max="30" step="0.5" value="0" oninput="updateAll()">
                    <span class="value" id="skewYVal">0¬∞</span>
                </div>
                <div class="slider-row">
                    <label>Opacidade:</label>
                    <input type="range" id="opacity" min="10" max="100" step="1" value="70" oninput="updateAll()">
                    <span class="value" id="opacityVal">70%</span>
                </div>
            </div>

            <!-- Posi√ß√£o e Bounds -->
            <div class="control-section">
                <h3>üìç Posi√ß√£o e Tamanho</h3>
                <div class="slider-row">
                    <label>Centro Lat:</label>
                    <input type="range" id="centerLat" min="-60" max="15" step="0.5" value="-22" oninput="updateAll()">
                    <span class="value" id="centerLatVal">-22¬∞</span>
                </div>
                <div class="slider-row">
                    <label>Centro Lng:</label>
                    <input type="range" id="centerLng" min="-90" max="-25" step="0.5" value="-55" oninput="updateAll()">
                    <span class="value" id="centerLngVal">-55¬∞</span>
                </div>
                <div class="slider-row">
                    <label>Largura:</label>
                    <input type="range" id="width" min="20" max="100" step="1" value="60" oninput="updateAll()">
                    <span class="value" id="widthVal">60¬∞</span>
                </div>
                <div class="slider-row">
                    <label>Altura:</label>
                    <input type="range" id="height" min="20" max="80" step="1" value="70" oninput="updateAll()">
                    <span class="value" id="heightVal">70¬∞</span>
                </div>
            </div>

            <!-- Deletar Tri√¢ngulos -->
            <div class="control-section">
                <h3>üóëÔ∏è Deletar √Åreas</h3>
                <button class="btn btn-danger" id="btnDeleteMode" onclick="toggleDeleteMode()">
                    ‚úÇÔ∏è Modo Deletar (clique nos tri√¢ngulos)
                </button>
                <div class="instructions" id="deleteInstructions" style="display:none;">
                    Clique nos tri√¢ngulos da imagem para exclu√≠-los.<br>
                    Tri√¢ngulos deletados ficam transparentes.
                </div>
                
                <div id="deletedList" class="triangle-list" style="display:none;">
                    <p style="color:#e74c3c; font-size:0.8em; margin-bottom:4px;">Tri√¢ngulos Deletados:</p>
                    <div id="deletedItems"></div>
                </div>
                
                <button class="btn btn-warning" onclick="restoreAllTriangles()" style="margin-top:5px;">
                    ‚Ü©Ô∏è Restaurar Todos
                </button>
            </div>

            <!-- A√ß√µes -->
            <div class="control-section">
                <h3>‚ö° A√ß√µes</h3>
                <button class="btn btn-success" onclick="redraw()">üîÑ Redesenhar</button>
                <div class="btn-grid">
                    <button class="btn btn-secondary" onclick="exportConfig()">üì§ Exportar</button>
                    <button class="btn btn-secondary" onclick="importConfig()">üì• Importar</button>
                </div>
            </div>

            <!-- Instru√ß√µes -->
            <div class="control-section">
                <h3>üìñ Dicas</h3>
                <div class="instructions">
                    ‚Ä¢ <b>Arraste os pontos</b> rosa no mapa<br>
                    ‚Ä¢ <b>Sliders</b> para ajustes globais<br>
                    ‚Ä¢ <b>Modo Deletar</b> para remover √°reas<br>
                    ‚Ä¢ <b>Scroll</b> para zoom do mapa
                </div>
            </div>
        </div>

        <div id="map">
            <canvas id="imageCanvas"></canvas>
            <canvas id="selectionCanvas"></canvas>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/delaunator@5.0.0/delaunator.min.js"></script>
    <script>
        // ===== ESTADO =====
        let map = null;
        let imageElement = null;
        let imageLoaded = false;
        let canvas, ctx;
        let selCanvas, selCtx;
        
        // Pontos de controle
        let controlPoints = []; // {id, marker, srcX, srcY, lat, lng}
        let gridRows = 4, gridCols = 4;
        let pointIdCounter = 0;
        
        // Triangula√ß√£o
        let triangles = []; // √≠ndices dos tri√¢ngulos
        let deletedTriangles = new Set(); // √≠ndices dos tri√¢ngulos deletados
        
        // Modo deletar
        let deleteMode = false;
        
        // Bounds da imagem
        let imageBounds = {
            north: 13, south: -57,
            west: -85, east: -25
        };

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initCanvas();
            setupEvents();
        });

        function initMap() {
            map = L.map('map', {
                center: [-25, -55],
                zoom: 4
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OSM',
                opacity: 0.8
            }).addTo(map);

            map.on('move zoom moveend zoomend', redraw);
        }

        function initCanvas() {
            canvas = document.getElementById('imageCanvas');
            ctx = canvas.getContext('2d');
            
            selCanvas = document.getElementById('selectionCanvas');
            selCtx = selCanvas.getContext('2d');
            
            resizeCanvas();
            new ResizeObserver(resizeCanvas).observe(document.getElementById('map'));
        }

        function resizeCanvas() {
            const mapEl = document.getElementById('map');
            canvas.width = selCanvas.width = mapEl.offsetWidth;
            canvas.height = selCanvas.height = mapEl.offsetHeight;
            redraw();
        }

        function setupEvents() {
            document.getElementById('imageInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => loadImage(ev.target.result, file.name);
                    reader.readAsDataURL(file);
                }
            });

            // Clique para deletar tri√¢ngulos
            selCanvas.addEventListener('click', function(e) {
                if (!deleteMode || !imageLoaded) return;
                
                const rect = selCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                clickOnTriangle(x, y);
            });

            // Cursor no modo deletar
            selCanvas.addEventListener('mousemove', function(e) {
                if (!deleteMode) return;
                selCanvas.style.cursor = 'crosshair';
            });
        }

        // ===== CARREGAR IMAGEM =====
        const NOAA = {
            goes19: { name: 'GOES-19', url: 'https://cdn.star.nesdis.noaa.gov/GOES19/ABI/SECTOR/ssa/13/latest.jpg' },
            goes16: { name: 'GOES-16', url: 'https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/ssa/13/latest.jpg' }
        };

        function loadNoaaImage(sat) {
            const s = NOAA[sat];
            document.getElementById('imageStatus').innerHTML = '‚è≥ Baixando...';
            loadImage(s.url + '?t=' + Date.now(), s.name);
        }

        function loadImage(src, name) {
            imageElement = new Image();
            imageElement.crossOrigin = 'anonymous';
            
            imageElement.onload = function() {
                imageLoaded = true;
                document.getElementById('imageStatus').innerHTML = `‚úÖ ${name} (${this.width}√ó${this.height})`;
                document.getElementById('imageStatus').style.color = '#00ff00';
                
                createGrid(gridRows, gridCols);
                triangulate();
                redraw();
            };
            
            imageElement.onerror = function() {
                document.getElementById('imageStatus').innerHTML = '‚ùå Erro';
                document.getElementById('imageStatus').style.color = '#ff4444';
            };
            
            imageElement.src = src;
        }

        // ===== GRID DE PONTOS =====
        function setGrid(rows, cols) {
            gridRows = rows;
            gridCols = cols;
            createGrid(rows, cols);
            triangulate();
            redraw();
        }

        function createGrid(rows, cols) {
            // Limpar pontos antigos
            controlPoints.forEach(p => { if (p.marker) map.removeLayer(p.marker); });
            controlPoints = [];
            pointIdCounter = 0;
            deletedTriangles.clear();
            
            updateBoundsFromSliders();
            
            const latStep = (imageBounds.north - imageBounds.south) / (rows - 1);
            const lngStep = (imageBounds.east - imageBounds.west) / (cols - 1);
            
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const lat = imageBounds.north - r * latStep;
                    const lng = imageBounds.west + c * lngStep;
                    
                    // Posi√ß√£o na imagem (0-1)
                    const srcX = c / (cols - 1);
                    const srcY = r / (rows - 1);
                    
                    addControlPoint(srcX, srcY, lat, lng);
                }
            }
            
            document.getElementById('pointCount').textContent = controlPoints.length;
        }

        function addControlPoint(srcX, srcY, lat, lng) {
            pointIdCounter++;
            const id = pointIdCounter;
            
            const icon = L.divIcon({
                className: 'control-point',
                html: id,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            const marker = L.marker([lat, lng], {
                icon: icon,
                draggable: true
            }).addTo(map);
            
            marker.on('drag dragend', function() {
                const ll = marker.getLatLng();
                const pt = controlPoints.find(p => p.id === id);
                if (pt) {
                    pt.lat = ll.lat;
                    pt.lng = ll.lng;
                }
                redraw();
            });
            
            controlPoints.push({ id, marker, srcX, srcY, lat, lng });
        }

        // ===== TRIANGULA√á√ÉO =====
        function triangulate() {
            if (controlPoints.length < 3) {
                triangles = [];
                return;
            }
            
            // Usar posi√ß√µes na tela para triangula√ß√£o
            const coords = [];
            controlPoints.forEach(p => {
                const pt = map.latLngToContainerPoint([p.lat, p.lng]);
                coords.push(pt.x, pt.y);
            });
            
            try {
                const delaunay = new Delaunator(coords);
                triangles = Array.from(delaunay.triangles);
            } catch (e) {
                triangles = [];
            }
            
            document.getElementById('triangleCount').textContent = triangles.length / 3;
        }

        // ===== DESENHAR =====
        function redraw() {
            if (!ctx) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            selCtx.clearRect(0, 0, selCanvas.width, selCanvas.height);
            
            if (!imageLoaded || !imageElement || controlPoints.length < 3) return;
            
            // Re-triangular com posi√ß√µes atuais
            triangulate();
            
            const opacity = parseFloat(document.getElementById('opacity').value) / 100;
            ctx.globalAlpha = opacity;
            
            const imgW = imageElement.naturalWidth;
            const imgH = imageElement.naturalHeight;
            
            // Obter transforma√ß√µes globais
            const scaleX = parseFloat(document.getElementById('scaleX').value);
            const scaleY = parseFloat(document.getElementById('scaleY').value);
            const rotation = parseFloat(document.getElementById('rotation').value) * Math.PI / 180;
            const skewX = parseFloat(document.getElementById('skewX').value) * Math.PI / 180;
            const skewY = parseFloat(document.getElementById('skewY').value) * Math.PI / 180;
            
            // Desenhar cada tri√¢ngulo
            for (let i = 0; i < triangles.length; i += 3) {
                const triIndex = i / 3;
                
                // Pular tri√¢ngulos deletados
                if (deletedTriangles.has(triIndex)) continue;
                
                const i0 = triangles[i];
                const i1 = triangles[i + 1];
                const i2 = triangles[i + 2];
                
                const p0 = controlPoints[i0];
                const p1 = controlPoints[i1];
                const p2 = controlPoints[i2];
                
                if (!p0 || !p1 || !p2) continue;
                
                // Posi√ß√µes na imagem
                const src0 = [p0.srcX * imgW, p0.srcY * imgH];
                const src1 = [p1.srcX * imgW, p1.srcY * imgH];
                const src2 = [p2.srcX * imgW, p2.srcY * imgH];
                
                // Posi√ß√µes na tela (com transforma√ß√£o)
                const dst0 = getTransformedPoint(p0.lat, p0.lng, scaleX, scaleY, rotation, skewX, skewY);
                const dst1 = getTransformedPoint(p1.lat, p1.lng, scaleX, scaleY, rotation, skewX, skewY);
                const dst2 = getTransformedPoint(p2.lat, p2.lng, scaleX, scaleY, rotation, skewX, skewY);
                
                drawTriangle(ctx, imageElement, src0, src1, src2, dst0, dst1, dst2);
            }
            
            // Desenhar contornos dos tri√¢ngulos no canvas de sele√ß√£o (modo deletar)
            if (deleteMode) {
                drawTriangleOutlines();
            }
            
            updateSliderDisplays();
        }

        function getTransformedPoint(lat, lng, scaleX, scaleY, rotation, skewX, skewY) {
            // Ponto base na tela
            const pt = map.latLngToContainerPoint([lat, lng]);
            
            // Centro da transforma√ß√£o
            const centerLat = parseFloat(document.getElementById('centerLat').value);
            const centerLng = parseFloat(document.getElementById('centerLng').value);
            const center = map.latLngToContainerPoint([centerLat, centerLng]);
            
            // Deslocar para origem
            let x = pt.x - center.x;
            let y = pt.y - center.y;
            
            // Aplicar escala
            x *= scaleX;
            y *= scaleY;
            
            // Aplicar cisalhamento
            const newX = x + y * Math.tan(skewX);
            const newY = y + x * Math.tan(skewY);
            x = newX;
            y = newY;
            
            // Aplicar rota√ß√£o
            const cos = Math.cos(rotation);
            const sin = Math.sin(rotation);
            const rx = x * cos - y * sin;
            const ry = x * sin + y * cos;
            
            // Voltar para posi√ß√£o original
            return [rx + center.x, ry + center.y];
        }

        function drawTriangle(ctx, img, src0, src1, src2, dst0, dst1, dst2) {
            ctx.save();
            
            ctx.beginPath();
            ctx.moveTo(dst0[0], dst0[1]);
            ctx.lineTo(dst1[0], dst1[1]);
            ctx.lineTo(dst2[0], dst2[1]);
            ctx.closePath();
            ctx.clip();
            
            // Transforma√ß√£o afim
            const denom = (src0[0] - src2[0]) * (src1[1] - src2[1]) - (src1[0] - src2[0]) * (src0[1] - src2[1]);
            if (Math.abs(denom) < 0.001) { ctx.restore(); return; }
            
            const a = ((dst0[0] - dst2[0]) * (src1[1] - src2[1]) - (dst1[0] - dst2[0]) * (src0[1] - src2[1])) / denom;
            const b = ((src0[0] - src2[0]) * (dst1[0] - dst2[0]) - (src1[0] - src2[0]) * (dst0[0] - dst2[0])) / denom;
            const c = dst0[0] - a * src0[0] - b * src0[1];
            const d = ((dst0[1] - dst2[1]) * (src1[1] - src2[1]) - (dst1[1] - dst2[1]) * (src0[1] - src2[1])) / denom;
            const e = ((src0[0] - src2[0]) * (dst1[1] - dst2[1]) - (src1[0] - src2[0]) * (dst0[1] - dst2[1])) / denom;
            const f = dst0[1] - d * src0[0] - e * src0[1];
            
            ctx.setTransform(a, d, b, e, c, f);
            ctx.drawImage(img, 0, 0);
            
            ctx.restore();
        }

        function drawTriangleOutlines() {
            selCtx.strokeStyle = 'rgba(255, 0, 100, 0.8)';
            selCtx.lineWidth = 2;
            
            const scaleX = parseFloat(document.getElementById('scaleX').value);
            const scaleY = parseFloat(document.getElementById('scaleY').value);
            const rotation = parseFloat(document.getElementById('rotation').value) * Math.PI / 180;
            const skewX = parseFloat(document.getElementById('skewX').value) * Math.PI / 180;
            const skewY = parseFloat(document.getElementById('skewY').value) * Math.PI / 180;
            
            for (let i = 0; i < triangles.length; i += 3) {
                const triIndex = i / 3;
                
                if (deletedTriangles.has(triIndex)) {
                    selCtx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
                    selCtx.setLineDash([5, 5]);
                } else {
                    selCtx.strokeStyle = 'rgba(255, 0, 100, 0.6)';
                    selCtx.setLineDash([]);
                }
                
                const p0 = controlPoints[triangles[i]];
                const p1 = controlPoints[triangles[i + 1]];
                const p2 = controlPoints[triangles[i + 2]];
                
                if (!p0 || !p1 || !p2) continue;
                
                const dst0 = getTransformedPoint(p0.lat, p0.lng, scaleX, scaleY, rotation, skewX, skewY);
                const dst1 = getTransformedPoint(p1.lat, p1.lng, scaleX, scaleY, rotation, skewX, skewY);
                const dst2 = getTransformedPoint(p2.lat, p2.lng, scaleX, scaleY, rotation, skewX, skewY);
                
                selCtx.beginPath();
                selCtx.moveTo(dst0[0], dst0[1]);
                selCtx.lineTo(dst1[0], dst1[1]);
                selCtx.lineTo(dst2[0], dst2[1]);
                selCtx.closePath();
                selCtx.stroke();
            }
        }

        // ===== MODO DELETAR =====
        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            const btn = document.getElementById('btnDeleteMode');
            const instr = document.getElementById('deleteInstructions');
            
            if (deleteMode) {
                btn.classList.add('active');
                btn.innerHTML = '‚úÇÔ∏è CLIQUE NOS TRI√ÇNGULOS!';
                instr.style.display = 'block';
                selCanvas.style.pointerEvents = 'auto';
                document.getElementById('map').classList.add('delete-mode-active');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '‚úÇÔ∏è Modo Deletar';
                instr.style.display = 'none';
                selCanvas.style.pointerEvents = 'none';
                selCanvas.style.cursor = 'default';
                document.getElementById('map').classList.remove('delete-mode-active');
            }
            
            redraw();
        }

        function clickOnTriangle(x, y) {
            const scaleX = parseFloat(document.getElementById('scaleX').value);
            const scaleY = parseFloat(document.getElementById('scaleY').value);
            const rotation = parseFloat(document.getElementById('rotation').value) * Math.PI / 180;
            const skewX = parseFloat(document.getElementById('skewX').value) * Math.PI / 180;
            const skewY = parseFloat(document.getElementById('skewY').value) * Math.PI / 180;
            
            for (let i = 0; i < triangles.length; i += 3) {
                const triIndex = i / 3;
                
                const p0 = controlPoints[triangles[i]];
                const p1 = controlPoints[triangles[i + 1]];
                const p2 = controlPoints[triangles[i + 2]];
                
                if (!p0 || !p1 || !p2) continue;
                
                const dst0 = getTransformedPoint(p0.lat, p0.lng, scaleX, scaleY, rotation, skewX, skewY);
                const dst1 = getTransformedPoint(p1.lat, p1.lng, scaleX, scaleY, rotation, skewX, skewY);
                const dst2 = getTransformedPoint(p2.lat, p2.lng, scaleX, scaleY, rotation, skewX, skewY);
                
                if (pointInTriangle(x, y, dst0, dst1, dst2)) {
                    if (deletedTriangles.has(triIndex)) {
                        deletedTriangles.delete(triIndex);
                    } else {
                        deletedTriangles.add(triIndex);
                    }
                    updateDeletedList();
                    redraw();
                    return;
                }
            }
        }

        function pointInTriangle(px, py, v0, v1, v2) {
            const area = 0.5 * (-v1[1] * v2[0] + v0[1] * (-v1[0] + v2[0]) + v0[0] * (v1[1] - v2[1]) + v1[0] * v2[1]);
            const s = 1 / (2 * area) * (v0[1] * v2[0] - v0[0] * v2[1] + (v2[1] - v0[1]) * px + (v0[0] - v2[0]) * py);
            const t = 1 / (2 * area) * (v0[0] * v1[1] - v0[1] * v1[0] + (v0[1] - v1[1]) * px + (v1[0] - v0[0]) * py);
            return s >= 0 && t >= 0 && (1 - s - t) >= 0;
        }

        function updateDeletedList() {
            const list = document.getElementById('deletedList');
            const items = document.getElementById('deletedItems');
            
            if (deletedTriangles.size === 0) {
                list.style.display = 'none';
                return;
            }
            
            list.style.display = 'block';
            let html = '';
            deletedTriangles.forEach(idx => {
                html += `<div class="triangle-item">
                    Tri√¢ngulo #${idx + 1}
                    <button onclick="restoreTriangle(${idx})">‚Ü©Ô∏è</button>
                </div>`;
            });
            items.innerHTML = html;
        }

        function restoreTriangle(idx) {
            deletedTriangles.delete(idx);
            updateDeletedList();
            redraw();
        }

        function restoreAllTriangles() {
            deletedTriangles.clear();
            updateDeletedList();
            redraw();
        }

        // ===== ATUALIZAR =====
        function updateAll() {
            updateBoundsFromSliders();
            redraw();
        }

        function updateBoundsFromSliders() {
            const centerLat = parseFloat(document.getElementById('centerLat').value);
            const centerLng = parseFloat(document.getElementById('centerLng').value);
            const w = parseFloat(document.getElementById('width').value);
            const h = parseFloat(document.getElementById('height').value);
            
            imageBounds.north = centerLat + h / 2;
            imageBounds.south = centerLat - h / 2;
            imageBounds.west = centerLng - w / 2;
            imageBounds.east = centerLng + w / 2;
        }

        function updateSliderDisplays() {
            document.getElementById('scaleXVal').textContent = parseFloat(document.getElementById('scaleX').value).toFixed(2);
            document.getElementById('scaleYVal').textContent = parseFloat(document.getElementById('scaleY').value).toFixed(2);
            document.getElementById('rotationVal').textContent = document.getElementById('rotation').value + '¬∞';
            document.getElementById('skewXVal').textContent = document.getElementById('skewX').value + '¬∞';
            document.getElementById('skewYVal').textContent = document.getElementById('skewY').value + '¬∞';
            document.getElementById('opacityVal').textContent = document.getElementById('opacity').value + '%';
            document.getElementById('centerLatVal').textContent = document.getElementById('centerLat').value + '¬∞';
            document.getElementById('centerLngVal').textContent = document.getElementById('centerLng').value + '¬∞';
            document.getElementById('widthVal').textContent = document.getElementById('width').value + '¬∞';
            document.getElementById('heightVal').textContent = document.getElementById('height').value + '¬∞';
        }

        // ===== EXPORT/IMPORT =====
        function exportConfig() {
            const data = {
                timestamp: new Date().toISOString(),
                grid: { rows: gridRows, cols: gridCols },
                points: controlPoints.map(p => ({ srcX: p.srcX, srcY: p.srcY, lat: p.lat, lng: p.lng })),
                deletedTriangles: Array.from(deletedTriangles),
                sliders: {
                    scaleX: document.getElementById('scaleX').value,
                    scaleY: document.getElementById('scaleY').value,
                    rotation: document.getElementById('rotation').value,
                    skewX: document.getElementById('skewX').value,
                    skewY: document.getElementById('skewY').value,
                    opacity: document.getElementById('opacity').value,
                    centerLat: document.getElementById('centerLat').value,
                    centerLng: document.getElementById('centerLng').value,
                    width: document.getElementById('width').value,
                    height: document.getElementById('height').value
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `alignment_v6_${new Date().toISOString().slice(0,16).replace(/:/g,'-')}.json`;
            a.click();
        }

        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    try {
                        const data = JSON.parse(ev.target.result);
                        applyConfig(data);
                    } catch (err) {
                        alert('Erro: ' + err.message);
                    }
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }

        function applyConfig(data) {
            if (data.sliders) {
                Object.keys(data.sliders).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = data.sliders[key];
                });
            }
            
            if (data.grid) {
                gridRows = data.grid.rows;
                gridCols = data.grid.cols;
            }
            
            if (data.points && imageLoaded) {
                controlPoints.forEach(p => { if (p.marker) map.removeLayer(p.marker); });
                controlPoints = [];
                pointIdCounter = 0;
                
                data.points.forEach(p => addControlPoint(p.srcX, p.srcY, p.lat, p.lng));
            }
            
            if (data.deletedTriangles) {
                deletedTriangles = new Set(data.deletedTriangles);
            }
            
            triangulate();
            updateDeletedList();
            redraw();
        }
    </script>
</body>
</html>
