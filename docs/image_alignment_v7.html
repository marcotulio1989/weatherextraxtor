<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ∞Ô∏è Alinhamento V7 - Cantos Arrast√°veis</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a15;
            color: #eee;
            overflow: hidden;
        }
        .container { display: flex; height: 100vh; }
        
        .control-panel {
            width: 320px;
            background: linear-gradient(180deg, #16213e 0%, #1a1a2e 100%);
            padding: 12px;
            overflow-y: auto;
            border-right: 2px solid #0f3460;
            z-index: 1000;
            flex-shrink: 0;
        }
        .control-panel h1 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #e94560;
            text-align: center;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 8px;
        }
        .control-section {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(15, 52, 96, 0.5);
            border-radius: 8px;
        }
        .control-section h3 {
            color: #00d9ff;
            margin-bottom: 8px;
            font-size: 0.8em;
        }
        .btn {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, #e94560, #c23a51); color: white; }
        .btn-secondary { background: #0f3460; color: #00d9ff; border: 1px solid #00d9ff; }
        .btn-success { background: linear-gradient(135deg, #00b894, #00a381); color: white; }
        .btn-warning { background: linear-gradient(135deg, #fdcb6e, #e17055); color: #1a1a2e; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.3); }
        .btn.active { background: #ff00ff !important; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255,0,255,0.5); }
            50% { box-shadow: 0 0 15px rgba(255,0,255,0.8); }
        }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .btn-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; }
        
        #map { flex: 1; background: #1a1a2e; position: relative; }
        
        .slider-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 6px;
        }
        .slider-row label {
            width: 65px;
            font-size: 0.7em;
            color: #aaa;
        }
        .slider-row input[type="range"] {
            flex: 1;
            height: 5px;
            border-radius: 3px;
            background: #0f3460;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        .slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00d9ff;
            cursor: pointer;
        }
        .slider-row .value {
            width: 45px;
            font-size: 0.7em;
            color: #00ff00;
            text-align: right;
            font-family: monospace;
        }
        
        .status-bar {
            font-size: 0.75em;
            color: #888;
            padding: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            margin-top: 6px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0; top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%; height: 100%;
        }
        
        .instructions {
            font-size: 0.7em;
            color: #888;
            line-height: 1.4;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            border-left: 2px solid #00d9ff;
        }
        .instructions.highlight {
            border-left-color: #00ff00;
            background: rgba(0,255,0,0.1);
            color: #00ff00;
        }
        
        /* Marcadores de canto */
        .corner-marker {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border: 2px solid white;
        }
        .corner-nw { background: #e74c3c; }
        .corner-ne { background: #3498db; }
        .corner-sw { background: #f39c12; }
        .corner-se { background: #27ae60; }
        
        /* Garantir que marcadores Leaflet fiquem acima dos canvas */
        .leaflet-marker-pane {
            z-index: 600 !important;
        }
        .leaflet-popup-pane {
            z-index: 700 !important;
        }
        
        /* Marcador de ponto de grade */
        .control-point {
            width: 14px;
            height: 14px;
            background: #ff00ff;
            border: 2px solid white;
            border-radius: 50%;
            cursor: move;
            box-shadow: 0 0 8px rgba(255,0,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            font-weight: bold;
            color: white;
        }
        
        /* Canvas overlay - z-index baixo para n√£o bloquear marcadores Leaflet */
        #imageCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 200;
        }
        
        #selectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 250;
        }
        
        .corner-coords {
            display: grid;
            grid-template-columns: auto 1fr 1fr;
            gap: 4px;
            font-size: 0.7em;
            margin-top: 8px;
        }
        .corner-coords span {
            padding: 3px 5px;
            background: #0a0a15;
            border-radius: 3px;
        }
        .corner-coords .label { 
            font-weight: bold; 
        }
        .corner-coords .nw { color: #e74c3c; }
        .corner-coords .ne { color: #3498db; }
        .corner-coords .sw { color: #f39c12; }
        .corner-coords .se { color: #27ae60; }
        
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        
        .delete-mode-active {
            border: 3px solid #e74c3c !important;
        }
        
        .triangle-list {
            max-height: 100px;
            overflow-y: auto;
            background: #0a0a15;
            padding: 4px;
            border-radius: 4px;
            margin-top: 6px;
        }
        .triangle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 3px 6px;
            margin-bottom: 2px;
            background: rgba(255,0,0,0.2);
            border-radius: 3px;
            font-size: 0.65em;
            border-left: 3px solid #e74c3c;
        }
        .triangle-item button {
            background: #00b894;
            border: none;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="control-panel">
            <h1>üõ∞Ô∏è Alinhamento V7</h1>

            <!-- Carregar Imagem -->
            <div class="control-section">
                <h3>üìÅ Imagem</h3>
                
                <!-- Seletor de Produto -->
                <div style="margin-bottom: 8px;">
                    <label style="font-size: 0.7em; color: #aaa;">Produto:</label>
                    <select id="productSelect" style="width: 100%; padding: 6px; background: #0f3460; color: #00d9ff; border: 1px solid #00d9ff; border-radius: 4px; font-size: 0.75em;">
                        <option value="GEOCOLOR">üåà GeoColor (Vis√≠vel/IR)</option>
                        <option value="13">üå°Ô∏è Band 13 - IR Limpo (10.3¬µm)</option>
                        <option value="02">‚òÄÔ∏è Band 02 - Vis√≠vel (0.64¬µm)</option>
                        <option value="08">üíß Band 08 - Vapor d'√Ågua Alto (6.2¬µm)</option>
                        <option value="09">üíß Band 09 - Vapor d'√Ågua M√©dio (6.9¬µm)</option>
                        <option value="10">üíß Band 10 - Vapor d'√Ågua Baixo (7.3¬µm)</option>
                        <option value="14">üå°Ô∏è Band 14 - IR (11.2¬µm)</option>
                        <option value="15">üå°Ô∏è Band 15 - IR (12.3¬µm)</option>
                        <option value="AirMass">üåÄ AirMass RGB</option>
                        <option value="Sandwich">ü•™ Sandwich RGB</option>
                        <option value="DayCloudPhase">‚òÅÔ∏è Day Cloud Phase</option>
                        <option value="NightMicrophysics">üåô Night Microphysics</option>
                        <option value="DUST">üèúÔ∏è Dust RGB</option>
                        <option value="FireTemperature">üî• Fire Temperature</option>
                    </select>
                </div>
                
                <!-- Seletor de Sat√©lite -->
                <div style="margin-bottom: 8px;">
                    <label style="font-size: 0.7em; color: #aaa;">Sat√©lite:</label>
                    <select id="satelliteSelect" style="width: 100%; padding: 6px; background: #0f3460; color: #00d9ff; border: 1px solid #00d9ff; border-radius: 4px; font-size: 0.75em;">
                        <option value="GOES19">üõ∞Ô∏è GOES-19 (Leste)</option>
                        <option value="GOES16">üõ∞Ô∏è GOES-16 (Leste Backup)</option>
                        <option value="GOES18">üõ∞Ô∏è GOES-18 (Oeste)</option>
                    </select>
                </div>
                
                <div class="btn-grid">
                    <button class="btn btn-primary" onclick="loadSectorImage()" style="font-size:0.7em;">üìç Setor SSA</button>
                    <button class="btn btn-success" onclick="loadFullDiskImage()" style="font-size:0.7em;">üåé Full Disk</button>
                </div>
                <div class="file-input-wrapper">
                    <button class="btn btn-secondary">üìÇ Arquivo Local</button>
                    <input type="file" id="imageInput" accept="image/*">
                </div>
                <div class="status-bar" id="imageStatus">Nenhuma imagem carregada</div>
            </div>

            <!-- Reproje√ß√£o Full Disk -->
            <div class="control-section" id="reprojectionSection" style="display: none;">
                <h3>üåç Reproje√ß√£o Full Disk ‚Üí Plano</h3>
                <div class="instructions" style="margin-bottom: 8px;">
                    Transforma o disco esf√©rico em mapa plano (Plate Carr√©e).
                </div>
                <button class="btn btn-warning" onclick="reprojectFullDisk()" id="btnReproject">
                    üîÑ Reprojetar para Plano
                </button>
                <div class="slider-row" style="margin-top: 8px;">
                    <label>Qualidade:</label>
                    <input type="range" id="reprojQuality" min="200" max="1000" step="100" value="600">
                    <span class="value" id="reprojQualityVal">600px</span>
                </div>
                <div class="slider-row">
                    <label>Sat Lon:</label>
                    <input type="range" id="satLongitude" min="-180" max="0" step="0.1" value="-75.2">
                    <span class="value" id="satLongitudeVal">-75.2¬∞</span>
                </div>
                <div class="status-bar" id="reprojStatus">Aguardando...</div>
            </div>

            <!-- Mapa de Fundo -->
            <div class="control-section">
                <h3>üó∫Ô∏è Mapa de Fundo</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                    <button class="btn btn-secondary map-layer-btn active" data-layer="contornos" onclick="setMapLayer('contornos')" style="font-size:0.65em;">
                        üìç Contornos
                    </button>
                    <button class="btn btn-secondary map-layer-btn" data-layer="contornosEscuro" onclick="setMapLayer('contornosEscuro')" style="font-size:0.65em;">
                        üåë Escuro
                    </button>
                    <button class="btn btn-secondary map-layer-btn" data-layer="fronteiras" onclick="setMapLayer('fronteiras')" style="font-size:0.65em;">
                        üî≤ Fronteiras
                    </button>
                    <button class="btn btn-secondary map-layer-btn" data-layer="osm" onclick="setMapLayer('osm')" style="font-size:0.65em;">
                        üèôÔ∏è OSM
                    </button>
                    <button class="btn btn-secondary map-layer-btn" data-layer="satelite" onclick="setMapLayer('satelite')" style="font-size:0.65em; grid-column: span 2;">
                        üõ∞Ô∏è Sat√©lite ESRI
                    </button>
                </div>
                <div class="slider-row" style="margin-top: 8px;">
                    <label>Opac. Mapa:</label>
                    <input type="range" id="mapOpacity" min="10" max="100" step="5" value="60" oninput="updateMapOpacity()">
                    <span class="value" id="mapOpacityVal">60%</span>
                </div>
            </div>

            <!-- Presets de √Årea -->
            <div class="control-section">
                <h3>‚ö° Presets de √Årea</h3>
                <div class="preset-grid">
                    <button class="btn btn-secondary" onclick="setPreset('goes_ssa')" style="font-size:0.65em;">
                        üõ∞Ô∏è GOES SSA
                    </button>
                    <button class="btn btn-secondary" onclick="setPreset('goes_full')" style="font-size:0.65em;">
                        üåé GOES Full Disk
                    </button>
                    <button class="btn btn-secondary" onclick="setPreset('brazil')" style="font-size:0.65em;">
                        üáßüá∑ Brasil
                    </button>
                    <button class="btn btn-secondary" onclick="setPreset('south_america')" style="font-size:0.65em;">
                        üåé Am√©rica do Sul
                    </button>
                </div>
                <div class="status-bar" style="margin-top: 6px;">
                    √Årea: <span id="currentArea">-</span>
                </div>
            </div>

            <!-- Ajustes da Imagem -->
            <div class="control-section">
                <h3>üîß Ajustes da Imagem</h3>
                <div class="slider-row">
                    <label>Opacidade:</label>
                    <input type="range" id="opacity" min="10" max="100" step="1" value="95" oninput="updateOpacity()">
                    <span class="value" id="opacityVal">95%</span>
                </div>
            </div>

            <!-- Exportar/Importar -->
            <div class="control-section">
                <h3>üíæ Salvar/Carregar</h3>
                <div class="btn-grid">
                    <button class="btn btn-success" onclick="exportConfig()">üì§ Exportar</button>
                    <button class="btn btn-secondary" onclick="importConfig()">üì• Importar</button>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ===== ESTADO =====
        let map = null;
        let imageElement = null;
        let imageLoaded = false;
        let imageOverlay = null; // Leaflet image overlay
        
        // Bounds da imagem
        let imageBounds = {
            north: 15,
            south: -55,
            west: -100,
            east: -30
        };
        
        // Nome do preset atual
        let currentPresetName = '-';

        // Presets conhecidos
        const PRESETS = {
            goes_ssa: {
                name: 'GOES SSA (South America Sector)',
                north: 14.98, south: -54.98,
                west: -101.04, east: -30.98
            },
            goes_full: {
                name: 'GOES Full Disk',
                north: 60, south: -60,
                west: -135, east: 15
            },
            brazil: {
                name: 'Brasil',
                north: 5.5, south: -34,
                west: -74, east: -34
            },
            south_america: {
                name: 'Am√©rica do Sul',
                north: 15, south: -56,
                west: -82, east: -34
            }
        };

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            setupEvents();
        });

        // Op√ß√µes de mapa de fundo
        const MAP_LAYERS = {
            contornos: {
                name: 'Contornos',
                url: 'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',
                attribution: '¬© CartoDB'
            },
            contornosEscuro: {
                name: 'Contornos Escuro',
                url: 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
                attribution: '¬© CartoDB'
            },
            fronteiras: {
                name: 'S√≥ Fronteiras',
                url: 'https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lines/{z}/{x}/{y}{r}.png',
                attribution: '¬© Stamen'
            },
            osm: {
                name: 'OpenStreetMap',
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '¬© OSM'
            },
            satelite: {
                name: 'Sat√©lite ESRI',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: '¬© ESRI'
            }
        };
        let currentBaseLayer = null;

        function initMap() {
            map = L.map('map', {
                center: [-20, -55],
                zoom: 4
            });

            // Usar mapa de contornos por padr√£o (sem cidades/labels)
            setMapLayer('contornos');
        }

        function setMapLayer(layerKey) {
            const layer = MAP_LAYERS[layerKey];
            if (!layer) return;
            
            if (currentBaseLayer) {
                map.removeLayer(currentBaseLayer);
            }
            
            const opacity = parseFloat(document.getElementById('mapOpacity').value) / 100;
            
            currentBaseLayer = L.tileLayer(layer.url, {
                attribution: layer.attribution,
                opacity: opacity,
                subdomains: 'abcd'
            }).addTo(map);
            
            // Atualizar bot√µes ativos
            document.querySelectorAll('.map-layer-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.layer === layerKey) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateMapOpacity() {
            const opacity = parseFloat(document.getElementById('mapOpacity').value) / 100;
            document.getElementById('mapOpacityVal').textContent = document.getElementById('mapOpacity').value + '%';
            if (currentBaseLayer) {
                currentBaseLayer.setOpacity(opacity);
            }
        }

        function setPreset(presetKey) {
            const preset = PRESETS[presetKey];
            if (!preset) return;

            // Atualizar bounds
            imageBounds.north = preset.north;
            imageBounds.south = preset.south;
            imageBounds.west = preset.west;
            imageBounds.east = preset.east;
            currentPresetName = preset.name;
            
            document.getElementById('currentArea').textContent = preset.name;

            // Ajustar vis√£o do mapa
            map.fitBounds([
                [preset.north, preset.west],
                [preset.south, preset.east]
            ], { padding: [20, 20] });

            // Se tiver imagem, atualizar overlay
            if (imageLoaded) {
                updateImageOverlay();
            }
        }

        // ===== EVENTOS =====
        function setupEvents() {
            document.getElementById('imageInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => loadImage(ev.target.result, file.name);
                    reader.readAsDataURL(file);
                }
            });
            
            // Eventos para sliders de reproje√ß√£o
            document.getElementById('reprojQuality').addEventListener('input', function() {
                document.getElementById('reprojQualityVal').textContent = this.value + 'px';
            });
            
            document.getElementById('satLongitude').addEventListener('input', function() {
                document.getElementById('satLongitudeVal').textContent = parseFloat(this.value).toFixed(1) + '¬∞';
            });
        }

        // ===== CARREGAR IMAGEM =====
        // Configura√ß√£o dos sat√©lites
        const SATELLITES = {
            GOES19: { name: 'GOES-19', longitude: -75.2, base: 'https://cdn.star.nesdis.noaa.gov/GOES19/ABI' },
            GOES16: { name: 'GOES-16', longitude: -75.2, base: 'https://cdn.star.nesdis.noaa.gov/GOES16/ABI' },
            GOES18: { name: 'GOES-18', longitude: -137.2, base: 'https://cdn.star.nesdis.noaa.gov/GOES18/ABI' }
        };
        
        // Produtos dispon√≠veis
        const PRODUCTS = {
            'GEOCOLOR': { name: 'GeoColor', folder: 'GEOCOLOR' },
            '02': { name: 'Band 02 Vis√≠vel', folder: '02' },
            '08': { name: 'Vapor d\'√Ågua Alto', folder: '08' },
            '09': { name: 'Vapor d\'√Ågua M√©dio', folder: '09' },
            '10': { name: 'Vapor d\'√Ågua Baixo', folder: '10' },
            '13': { name: 'IR Limpo 10.3¬µm', folder: '13' },
            '14': { name: 'IR 11.2¬µm', folder: '14' },
            '15': { name: 'IR 12.3¬µm', folder: '15' },
            'AirMass': { name: 'AirMass RGB', folder: 'AirMass' },
            'Sandwich': { name: 'Sandwich RGB', folder: 'Sandwich' },
            'DayCloudPhase': { name: 'Day Cloud Phase', folder: 'DayCloudPhase' },
            'NightMicrophysics': { name: 'Night Microphysics', folder: 'NightMicrophysics' },
            'DUST': { name: 'Dust RGB', folder: 'DUST' },
            'FireTemperature': { name: 'Fire Temperature', folder: 'FireTemperature' }
        };
        
        let isFullDisk = false;
        let originalFullDiskImage = null;

        function loadSectorImage() {
            const satKey = document.getElementById('satelliteSelect').value;
            const productKey = document.getElementById('productSelect').value;
            const sat = SATELLITES[satKey];
            const product = PRODUCTS[productKey];
            
            const url = `${sat.base}/SECTOR/ssa/${product.folder}/latest.jpg`;
            const name = `${sat.name} SSA ${product.name}`;
            
            document.getElementById('imageStatus').innerHTML = '‚è≥ Baixando ' + name + '...';
            
            // Esconder se√ß√£o de reproje√ß√£o
            document.getElementById('reprojectionSection').style.display = 'none';
            isFullDisk = false;
            
            // Aplicar preset GOES SSA automaticamente
            setPreset('goes_ssa');
            
            loadImage(url + '?t=' + Date.now(), name);
        }
        
        function loadFullDiskImage() {
            const satKey = document.getElementById('satelliteSelect').value;
            const productKey = document.getElementById('productSelect').value;
            const sat = SATELLITES[satKey];
            const product = PRODUCTS[productKey];
            
            const url = `${sat.base}/FD/${product.folder}/latest.jpg`;
            const name = `${sat.name} Full Disk ${product.name}`;
            
            document.getElementById('imageStatus').innerHTML = '‚è≥ Baixando ' + name + '...';
            document.getElementById('satLongitude').value = sat.longitude;
            document.getElementById('satLongitudeVal').textContent = sat.longitude + '¬∞';
            
            isFullDisk = true;
            
            // Mostrar se√ß√£o de reproje√ß√£o
            document.getElementById('reprojectionSection').style.display = 'block';
            document.getElementById('reprojStatus').innerHTML = '‚è≥ Carregando disco...';
            
            // Aplicar preset full disk
            setPreset('goes_full');
            
            // Carregar imagem original
            originalFullDiskImage = new Image();
            originalFullDiskImage.crossOrigin = 'anonymous';
            
            originalFullDiskImage.onload = function() {
                document.getElementById('imageStatus').innerHTML = `‚úÖ ${name} (${this.width}√ó${this.height})`;
                document.getElementById('imageStatus').style.color = '#00ff00';
                document.getElementById('reprojStatus').innerHTML = '‚úÖ Pronto! Clique em "Reprojetar para Plano"';
                document.getElementById('reprojStatus').style.color = '#00ff00';
            };
            
            originalFullDiskImage.onerror = function() {
                document.getElementById('imageStatus').innerHTML = '‚ùå Erro ao carregar';
                document.getElementById('imageStatus').style.color = '#ff4444';
            };
            
            originalFullDiskImage.src = url + '?t=' + Date.now();
        }
        
        // Fun√ß√µes legadas para compatibilidade
        function loadNoaaImage(sat) {
            document.getElementById('satelliteSelect').value = sat === 'goes19' ? 'GOES19' : 'GOES16';
            loadSectorImage();
        }
        
        function loadFullDisk(sat) {
            document.getElementById('satelliteSelect').value = sat === 'goes19' ? 'GOES19' : 'GOES16';
            loadFullDiskImage();
        }
        
        // ===== REPROJE√á√ÉO GEOESTACION√ÅRIA ‚Üí PLATE CARR√âE =====
        function reprojectFullDisk() {
            if (!originalFullDiskImage) {
                alert('Carregue uma imagem Full Disk primeiro!');
                return;
            }
            
            document.getElementById('reprojStatus').innerHTML = 'üîÑ Reprojetando...';
            document.getElementById('btnReproject').disabled = true;
            
            // Usar setTimeout para permitir UI update
            setTimeout(() => {
                try {
                    const reprojectedCanvas = geostatToPlateCarree(originalFullDiskImage);
                    
                    // Converter canvas para imagem
                    imageElement = new Image();
                    imageElement.onload = function() {
                        imageLoaded = true;
                        isFullDisk = false; // Agora √© uma imagem plana
                        
                        document.getElementById('reprojStatus').innerHTML = '‚úÖ Reproje√ß√£o conclu√≠da!';
                        document.getElementById('reprojStatus').style.color = '#00ff00';
                        document.getElementById('btnReproject').disabled = false;
                        
                        // Aplicar bounds da √°rea vis√≠vel do sat√©lite
                        const satLonDeg = parseFloat(document.getElementById('satLongitude').value);
                        const visibleRange = 81; // graus de visibilidade do sat√©lite
                        
                        // Definir bounds para √°rea vis√≠vel do sat√©lite
                        imageBounds.north = visibleRange;
                        imageBounds.south = -visibleRange;
                        imageBounds.west = satLonDeg - visibleRange;
                        imageBounds.east = satLonDeg + visibleRange;
                        
                        currentPresetName = 'Full Disk Reprojetado';
                        document.getElementById('currentArea').textContent = currentPresetName;
                        
                        // Atualizar overlay primeiro
                        updateImageOverlay();
                        
                        // Ajustar vis√£o do mapa para a √°rea da imagem
                        const bounds = L.latLngBounds(
                            [imageBounds.south, imageBounds.west],
                            [imageBounds.north, imageBounds.east]
                        );
                        map.fitBounds(bounds, { 
                            padding: [20, 20],
                            animate: true 
                        });
                    };
                    imageElement.src = reprojectedCanvas.toDataURL('image/png');
                    
                } catch (err) {
                    document.getElementById('reprojStatus').innerHTML = '‚ùå Erro: ' + err.message;
                    document.getElementById('reprojStatus').style.color = '#ff4444';
                    document.getElementById('btnReproject').disabled = false;
                }
            }, 50);
        }
        
        function geostatToPlateCarree(srcImg) {
            const quality = parseInt(document.getElementById('reprojQuality').value) || 600;
            const satLonDeg = parseFloat(document.getElementById('satLongitude').value);
            const satLon = satLonDeg * Math.PI / 180;
            
            // √Årea vis√≠vel do sat√©lite (aproximadamente 81¬∞ em cada dire√ß√£o)
            const visibleRange = 81 * Math.PI / 180; // em radianos
            
            // Limites da √°rea vis√≠vel
            const minLon = satLon - visibleRange;
            const maxLon = satLon + visibleRange;
            const minLat = -visibleRange;
            const maxLat = visibleRange;
            
            // Dimens√µes da imagem de sa√≠da (apenas √°rea vis√≠vel)
            const outWidth = quality;
            const outHeight = quality; // Quadrado para √°rea vis√≠vel
            
            // Criar canvas de sa√≠da
            const outCanvas = document.createElement('canvas');
            outCanvas.width = outWidth;
            outCanvas.height = outHeight;
            const outCtx = outCanvas.getContext('2d');
            
            // Criar canvas tempor√°rio para ler pixels da imagem fonte
            const srcCanvas = document.createElement('canvas');
            srcCanvas.width = srcImg.naturalWidth;
            srcCanvas.height = srcImg.naturalHeight;
            const srcCtx = srcCanvas.getContext('2d');
            srcCtx.drawImage(srcImg, 0, 0);
            
            const srcData = srcCtx.getImageData(0, 0, srcCanvas.width, srcCanvas.height);
            const outData = outCtx.createImageData(outWidth, outHeight);
            
            // Centro e raio do disco na imagem fonte
            const cx = srcCanvas.width / 2;
            const cy = srcCanvas.height / 2;
            const radius = Math.min(cx, cy) * 0.98; // Um pouco menor para evitar bordas
            
            // Para cada pixel na imagem de sa√≠da (Plate Carr√©e - apenas √°rea vis√≠vel)
            for (let y = 0; y < outHeight; y++) {
                for (let x = 0; x < outWidth; x++) {
                    // Converter posi√ß√£o para lat/lon (dentro da √°rea vis√≠vel)
                    const lon = minLon + (x / outWidth) * (maxLon - minLon);
                    const lat = maxLat - (y / outHeight) * (maxLat - minLat);
                    
                    // Diferen√ßa de longitude em rela√ß√£o ao sat√©lite
                    const lonDiff = lon - satLon;
                    
                    // Proje√ß√£o inversa: lat/lon ‚Üí posi√ß√£o no disco
                    // F√≥rmula simplificada para proje√ß√£o geoestacion√°ria
                    const cosLat = Math.cos(lat);
                    const sinLat = Math.sin(lat);
                    const cosLonDiff = Math.cos(lonDiff);
                    const sinLonDiff = Math.sin(lonDiff);
                    
                    // Verificar se o ponto est√° no lado vis√≠vel da Terra
                    const cosc = sinLat * 0 + cosLat * cosLonDiff;
                    if (cosc < 0.1) {
                        const idx = (y * outWidth + x) * 4;
                        outData.data[idx] = 0;
                        outData.data[idx + 1] = 0;
                        outData.data[idx + 2] = 0;
                        outData.data[idx + 3] = 0;
                        continue;
                    }
                    
                    // Coordenadas normalizadas no disco (-1 a 1)
                    const diskX = cosLat * sinLonDiff;
                    const diskY = -sinLat; // Y invertido
                    
                    // Converter para coordenadas de pixel na imagem fonte
                    const srcX = Math.round(cx + diskX * radius);
                    const srcY = Math.round(cy + diskY * radius);
                    
                    // Verificar limites
                    if (srcX < 0 || srcX >= srcCanvas.width || srcY < 0 || srcY >= srcCanvas.height) {
                        const idx = (y * outWidth + x) * 4;
                        outData.data[idx] = 0;
                        outData.data[idx + 1] = 0;
                        outData.data[idx + 2] = 0;
                        outData.data[idx + 3] = 0;
                        continue;
                    }
                    
                    // Copiar pixel
                    const srcIdx = (srcY * srcCanvas.width + srcX) * 4;
                    const dstIdx = (y * outWidth + x) * 4;
                    
                    outData.data[dstIdx] = srcData.data[srcIdx];
                    outData.data[dstIdx + 1] = srcData.data[srcIdx + 1];
                    outData.data[dstIdx + 2] = srcData.data[srcIdx + 2];
                    outData.data[dstIdx + 3] = srcData.data[srcIdx + 3];
                }
            }
            
            outCtx.putImageData(outData, 0, 0);
            return outCanvas;
        }

        function loadImage(src, name) {
            imageElement = new Image();
            imageElement.crossOrigin = 'anonymous';
            
            imageElement.onload = function() {
                imageLoaded = true;
                document.getElementById('imageStatus').innerHTML = `‚úÖ ${name} (${this.width}√ó${this.height})`;
                document.getElementById('imageStatus').style.color = '#00ff00';
                
                updateImageOverlay();
            };
            
            imageElement.onerror = function() {
                document.getElementById('imageStatus').innerHTML = '‚ùå Erro ao carregar';
                document.getElementById('imageStatus').style.color = '#ff4444';
            };
            
            imageElement.src = src;
        }
        
        // ===== IMAGE OVERLAY (usando Leaflet) =====
        function updateImageOverlay() {
            if (!imageLoaded || !imageElement) return;
            
            // Remover overlay anterior
            if (imageOverlay) {
                map.removeLayer(imageOverlay);
            }
            
            // Criar bounds do Leaflet
            const bounds = L.latLngBounds(
                [imageBounds.south, imageBounds.west],
                [imageBounds.north, imageBounds.east]
            );
            
            // Obter opacidade
            const opacity = parseFloat(document.getElementById('opacity').value) / 100;
            
            // Criar image overlay
            imageOverlay = L.imageOverlay(imageElement.src, bounds, {
                opacity: opacity,
                interactive: false
            }).addTo(map);
            
            // Garantir que fica abaixo dos controles do mapa
            imageOverlay.bringToBack();
        }
        
        function updateOpacity() {
            if (imageOverlay) {
                const opacity = parseFloat(document.getElementById('opacity').value) / 100;
                imageOverlay.setOpacity(opacity);
            }
            document.getElementById('opacityVal').textContent = document.getElementById('opacity').value + '%';
        }

        // ===== EXPORT/IMPORT =====
        function exportConfig() {
            const data = {
                timestamp: new Date().toISOString(),
                version: 'v7-simple',
                bounds: imageBounds,
                opacity: document.getElementById('opacity').value
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `alignment_v7_${new Date().toISOString().slice(0,16).replace(/:/g,'-')}.json`;
            a.click();
        }

        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    try {
                        const data = JSON.parse(ev.target.result);
                        applyConfig(data);
                    } catch (err) {
                        alert('Erro ao importar: ' + err.message);
                    }
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }

        function applyConfig(data) {
            // Aplicar bounds
            if (data.bounds) {
                imageBounds = data.bounds;
                updateImageOverlay();
            }
            
            // Aplicar opacidade
            if (data.opacity) {
                document.getElementById('opacity').value = data.opacity;
                updateOpacity();
            }
        }
    </script>
</body>
</html>
