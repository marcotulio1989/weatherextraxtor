<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ∞Ô∏è Ferramenta de Alinhamento de Imagem Sat√©lite</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Painel de Controle */
        .control-panel {
            width: 320px;
            background: linear-gradient(180deg, #16213e 0%, #1a1a2e 100%);
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #0f3460;
            z-index: 1000;
        }

        .control-panel h1 {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #e94560;
            text-align: center;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 10px;
        }

        .control-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(15, 52, 96, 0.5);
            border-radius: 10px;
        }

        .control-section h3 {
            color: #00d9ff;
            margin-bottom: 12px;
            font-size: 0.95em;
        }

        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .control-row label {
            flex: 0 0 80px;
            font-size: 0.85em;
            color: #aaa;
        }

        .control-row input[type="range"] {
            flex: 1;
            accent-color: #e94560;
        }

        .control-row input[type="number"] {
            width: 70px;
            padding: 5px;
            border: 1px solid #0f3460;
            background: #1a1a2e;
            color: #fff;
            border-radius: 5px;
            text-align: center;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e94560, #c23a51);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #0f3460, #16213e);
            color: #00d9ff;
            border: 1px solid #00d9ff;
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894, #00a381);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: #1a1a2e;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        /* √Årea do Mapa */
        .map-area {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Marcadores de Controle - estilo para os markers Leaflet */
        .control-marker {
            width: 24px !important;
            height: 24px !important;
            border-radius: 50%;
            border: 3px solid white;
            cursor: grab !important;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .control-marker:hover {
            transform: scale(1.2);
        }

        .control-marker.corner-tl { background: #ff6b6b; }
        .control-marker.corner-tr { background: #4ecdc4; }
        .control-marker.corner-bl { background: #ffe66d; }
        .control-marker.corner-br { background: #95e1d3; }

        /* Info Panel */
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 340px;
            background: rgba(26, 26, 46, 0.95);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid #0f3460;
            z-index: 1000;
            max-width: 400px;
        }

        .info-panel h4 {
            color: #00d9ff;
            margin-bottom: 10px;
        }

        .info-panel pre {
            font-size: 0.75em;
            color: #aaa;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
        }

        /* Instru√ß√µes */
        .instructions {
            font-size: 0.8em;
            color: #888;
            line-height: 1.5;
            margin-top: 10px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        /* Coordenadas dos pontos */
        .coords-display {
            font-family: monospace;
            font-size: 0.75em;
            background: #0a0a15;
            padding: 10px;
            border-radius: 5px;
            max-height: 120px;
            overflow-y: auto;
        }

        /* Toggle para visibilidade */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #0f3460;
            transition: 0.4s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #00d9ff;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Leaflet Image Overlay customization */
        .leaflet-image-layer {
            image-rendering: auto;
        }

        /* Zoom control customization */
        .leaflet-control-zoom {
            border: 2px solid #0f3460 !important;
        }

        .leaflet-control-zoom a {
            background-color: #16213e !important;
            color: #00d9ff !important;
        }

        .leaflet-control-zoom a:hover {
            background-color: #0f3460 !important;
        }

        /* Modal de Salvamento */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #16213e;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #00d9ff;
            margin-bottom: 20px;
        }

        .modal-content pre {
            background: #0a0a15;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.8em;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2em;
            color: #e94560;
            cursor: pointer;
        }

        /* GCP Points styling */
        .gcp-marker {
            background: #ff00ff;
            border: 3px solid #fff;
            border-radius: 50%;
            width: 20px !important;
            height: 20px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255,0,255,0.8);
        }

        .gcp-list {
            max-height: 200px;
            overflow-y: auto;
            background: #0a0a15;
            border-radius: 5px;
            padding: 10px;
        }

        .gcp-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(15, 52, 96, 0.5);
            border-radius: 5px;
            font-size: 0.8em;
        }

        .gcp-item input {
            width: 70px;
            padding: 3px;
            background: #1a1a2e;
            border: 1px solid #0f3460;
            color: #fff;
            border-radius: 3px;
            text-align: center;
            font-size: 0.9em;
        }

        .gcp-item .gcp-number {
            background: #ff00ff;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .gcp-item button {
            background: #e94560;
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .gcp-mode-active {
            background: linear-gradient(135deg, #ff00ff, #cc00cc) !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255,0,255,0.5); }
            50% { box-shadow: 0 0 20px rgba(255,0,255,0.8); }
        }

        .gcp-instructions {
            font-size: 0.75em;
            color: #ff00ff;
            margin-top: 8px;
            padding: 8px;
            background: rgba(255,0,255,0.1);
            border-radius: 5px;
            display: none;
        }

        .gcp-instructions.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Painel de Controle -->
        <div class="control-panel">
            <h1>üõ∞Ô∏è Alinhamento de Sat√©lite</h1>

            <!-- Baixar Imagem Sat√©lite -->
            <div class="control-section">
                <h3>üõ∞Ô∏è Carregar Imagem Sat√©lite</h3>
                <select id="satelliteProduct" style="width: 100%; padding: 8px; background: #1a1a2e; border: 1px solid #0f3460; color: #fff; border-radius: 5px; margin-bottom: 10px;">
                    <optgroup label="GOES-16 Am√©rica do Sul">
                        <option value="goes16-ssa-ch13">GOES-16 SSA - Infravermelho (Ch13)</option>
                        <option value="goes16-ssa-ch02">GOES-16 SSA - Vis√≠vel (Ch02)</option>
                        <option value="goes16-ssa-ch08">GOES-16 SSA - Vapor d'√Ågua (Ch08)</option>
                    </optgroup>
                    <optgroup label="GOES-16 Brasil">
                        <option value="goes16-br-ch13">GOES-16 Brasil - Infravermelho</option>
                    </optgroup>
                    <optgroup label="Windy.com (Funciona direto!)">
                        <option value="windy-satellite">Windy Sat√©lite IR</option>
                        <option value="windy-radar">Windy Radar</option>
                    </optgroup>
                </select>
                <button class="btn btn-primary" onclick="fetchSatelliteImage()" id="btnFetchSat">
                    üîÑ Buscar Imagem do Sat√©lite
                </button>
                <button class="btn btn-secondary" onclick="openCPTECPage()" style="margin-top:5px;">
                    üåê Abrir CPTEC (salvar manualmente)
                </button>
                <div id="satStatus" style="font-size: 0.8em; color: #888; margin-top: 8px;"></div>
            </div>

            <!-- Carregar Imagem -->
            <div class="control-section">
                <h3>üìÅ Ou Carregar Imagem Manual</h3>
                <div class="file-input-wrapper">
                    <button class="btn btn-secondary">Selecionar Arquivo</button>
                    <input type="file" id="imageInput" accept="image/*">
                </div>
                <input type="text" id="imageUrl" placeholder="Ou cole URL da imagem..." 
                       style="width: 100%; padding: 8px; margin-top: 10px; background: #1a1a2e; border: 1px solid #0f3460; color: #fff; border-radius: 5px;">
                <button class="btn btn-secondary" onclick="loadImageFromUrl()" style="margin-top: 10px;">Carregar URL</button>
            </div>

            <!-- Transforma√ß√µes Globais -->
            <div class="control-section">
                <h3>ÔøΩ Ajuste de Bounds (Coordenadas)</h3>
                
                <div class="control-row">
                    <label>Norte:</label>
                    <input type="number" id="boundNorth" value="10" step="0.1" style="flex:1;">
                </div>

                <div class="control-row">
                    <label>Sul:</label>
                    <input type="number" id="boundSouth" value="-55" step="0.1" style="flex:1;">
                </div>

                <div class="control-row">
                    <label>Leste:</label>
                    <input type="number" id="boundEast" value="-25" step="0.1" style="flex:1;">
                </div>

                <div class="control-row">
                    <label>Oeste:</label>
                    <input type="number" id="boundWest" value="-85" step="0.1" style="flex:1;">
                </div>

                <div class="control-row">
                    <label>Opacidade:</label>
                    <input type="range" id="opacity" min="0" max="1" value="0.7" step="0.05">
                    <input type="number" id="opacityValue" value="0.7" step="0.05">
                </div>

                <button class="btn btn-secondary" onclick="fitImageToView()" style="margin-top:10px;">
                    üîç Ajustar Vista √† Imagem
                </button>
            </div>

            <!-- Visibilidade -->
            <div class="control-section">
                <h3>üëÅÔ∏è Visibilidade</h3>
                
                <div class="toggle-container">
                    <span>Mostrar Imagem</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showImage" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-container">
                    <span>Mostrar Pontos de Controle</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showControlPoints" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-container">
                    <span>Bloquear Arraste</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="lockDrag">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Pontos de Controle GCP -->
            <div class="control-section">
                <h3>üìå Pontos de Refer√™ncia (GCP)</h3>
                <button class="btn btn-primary" id="btnGcpMode" onclick="toggleGcpMode()">
                    üéØ Marcar Pontos no Mapa
                </button>
                <div class="gcp-instructions" id="gcpInstructions">
                    ‚ú® Clique no mapa para adicionar pontos de refer√™ncia.<br>
                    üìç Cada ponto deve corresponder a uma localiza√ß√£o conhecida.<br>
                    üî¢ M√≠nimo 2 pontos para alinhar.
                </div>
                <div class="gcp-list" id="gcpList">
                    <p style="color:#888; font-size:0.85em;">Nenhum ponto marcado ainda</p>
                </div>
                <button class="btn btn-success" onclick="alignFromGcpPoints()" style="margin-top:10px;">
                    ‚ú® Alinhar Automaticamente
                </button>
                <button class="btn btn-secondary" onclick="clearAllGcpPoints()" style="margin-top:5px;">
                    üóëÔ∏è Limpar Todos os Pontos
                </button>
            </div>

            <!-- A√ß√µes -->
            <div class="control-section">
                <h3>‚ö° A√ß√µes</h3>
                <button class="btn btn-warning" onclick="resetTransformations()">üîÑ Resetar Tudo</button>
                <button class="btn btn-success" onclick="saveAlignment()">üíæ Salvar Alinhamento</button>
                <button class="btn btn-secondary" onclick="exportAsJSON()">üì§ Exportar JSON</button>
                <button class="btn btn-secondary" onclick="loadFromJSON()">üì• Importar JSON</button>
            </div>

            <!-- Coordenadas -->
            <div class="control-section">
                <h3>üìç Coordenadas dos Pontos</h3>
                <div id="coordsDisplay" class="coords-display">
                    Carregue uma imagem para ver as coordenadas
                </div>
            </div>

            <!-- Instru√ß√µes -->
            <div class="control-section">
                <h3>üìñ Instru√ß√µes</h3>
                <ul class="instructions">
                    <li>Carregue uma imagem de sat√©lite</li>
                    <li>A imagem fica <b>fixada ao mapa</b> - zoom e pan funcionam!</li>
                    <li>Arraste os <b>marcadores coloridos</b> para ajustar os cantos</li>
                    <li>Ou edite as coordenadas diretamente nos campos</li>
                    <li>Clique em "Salvar Alinhamento" quando terminar</li>
                </ul>
            </div>
        </div>

        <!-- √Årea do Mapa -->
        <div class="map-area">
            <div id="map"></div>
        </div>
    </div>

    <!-- Modal de Resultado -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2>‚úÖ Alinhamento Salvo!</h2>
            <p>Par√¢metros de transforma√ß√£o capturados:</p>
            <pre id="resultJSON"></pre>
            <button class="btn btn-primary" onclick="copyToClipboard()" style="margin-top: 15px;">üìã Copiar JSON</button>
            <button class="btn btn-secondary" onclick="downloadJSON()" style="margin-top: 10px;">üíæ Baixar Arquivo</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ===== ESTADO GLOBAL =====
        let map;
        let imageOverlay = null;
        let cornerMarkers = {};
        let imageBounds = null;
        let originalImageSize = { width: 0, height: 0 };
        let currentImageUrl = null;
        
        // GCP (Ground Control Points)
        let gcpMode = false;
        let gcpPoints = [];  // Array de {marker, lat, lng, id}
        let gcpCounter = 0;
        
        // Bounds padr√£o para Am√©rica do Sul (aproximado para GOES-16)
        const defaultBounds = {
            north: 10,
            south: -55,
            east: -25,
            west: -85
        };

        // ===== INICIALIZA√á√ÉO DO MAPA =====
        function initMap() {
            map = L.map('map', {
                center: [-22.0, -41.0],
                zoom: 5,
                zoomControl: true,
                zoomSnap: 0.25,        // Permite zoom mais suave
                zoomDelta: 0.5,        // Controla incremento do zoom
                wheelPxPerZoomLevel: 120  // Sensibilidade do scroll (maior = menos sens√≠vel)
            });

            // Camadas de mapa
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            });

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            });

            const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap'
            });

            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CartoDB'
            });

            osmLayer.addTo(map);

            L.control.layers({
                'OpenStreetMap': osmLayer,
                'Sat√©lite (Esri)': satelliteLayer,
                'Topogr√°fico': topoLayer,
                'Dark Mode': darkLayer
            }).addTo(map);

            L.control.scale({ imperial: false }).addTo(map);

            // Atualizar display quando mapa move
            map.on('moveend zoomend', updateCoordsDisplay);
        }

        // ===== ABRIR CPTEC =====
        function openCPTECPage() {
            window.open('http://satelite.cptec.inpe.br/acervo/goes16.formulario.logic?i=br', '_blank');
        }

        // ===== BUSCAR IMAGEM SAT√âLITE =====
        async function fetchSatelliteImage() {
            const product = document.getElementById('satelliteProduct').value;
            const status = document.getElementById('satStatus');
            const btn = document.getElementById('btnFetchSat');
            
            btn.disabled = true;
            status.innerHTML = '‚è≥ Buscando imagem...';
            status.style.color = '#ffff00';

            const imageConfigs = {
                'windy-satellite': {
                    url: 'https://ims.windy.com/sat/satellite/satellite/2026/01/06/12/satellite_2026010612.jpg',
                    bounds: { north: 70, south: -60, east: 50, west: -120 }
                },
                'windy-radar': {
                    url: 'https://ims.windy.com/radar/radar/2026/01/06/12/radar_2026010612.jpg',
                    bounds: { north: 70, south: -60, east: 50, west: -120 }
                },
                'goes16-ssa-ch13': {
                    url: 'https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/ssa/13/latest.jpg',
                    bounds: { north: 15, south: -60, east: -25, west: -110 }
                },
                'goes16-ssa-ch02': {
                    url: 'https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/ssa/02/latest.jpg',
                    bounds: { north: 15, south: -60, east: -25, west: -110 }
                },
                'goes16-ssa-ch08': {
                    url: 'https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/ssa/08/latest.jpg',
                    bounds: { north: 15, south: -60, east: -25, west: -110 }
                },
                'goes16-br-ch13': {
                    url: 'https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/ssa/GEOCOLOR/latest.jpg',
                    bounds: { north: 15, south: -60, east: -25, west: -110 }
                }
            };

            const config = imageConfigs[product];
            
            if (!config) {
                status.innerHTML = '‚ùå Produto n√£o dispon√≠vel';
                status.style.color = '#ff4444';
                btn.disabled = false;
                return;
            }

            try {
                loadImageAsOverlay(config.url, config.bounds);
                status.innerHTML = '‚úÖ Imagem carregada! Arraste os marcadores para alinhar.';
                status.style.color = '#00ff00';
            } catch (error) {
                status.innerHTML = `‚ùå Erro: ${error.message}`;
                status.style.color = '#ff4444';
            }
            
            btn.disabled = false;
        }

        // ===== CARREGAR IMAGEM COMO OVERLAY NO MAPA =====
        function loadImageAsOverlay(imageUrl, bounds) {
            // Remover overlay anterior
            if (imageOverlay) {
                map.removeLayer(imageOverlay);
            }
            removeCornerMarkers();

            currentImageUrl = imageUrl;
            
            // Criar bounds para o Leaflet
            const b = bounds || defaultBounds;
            imageBounds = L.latLngBounds(
                [b.south, b.west],  // SW corner
                [b.north, b.east]   // NE corner
            );

            // Criar imagem tempor√°ria para obter dimens√µes
            const tempImg = new Image();
            tempImg.crossOrigin = 'anonymous';
            tempImg.onload = function() {
                originalImageSize = {
                    width: this.naturalWidth,
                    height: this.naturalHeight
                };
                
                // Criar overlay
                const opacity = parseFloat(document.getElementById('opacity').value);
                imageOverlay = L.imageOverlay(imageUrl, imageBounds, {
                    opacity: opacity,
                    interactive: false,
                    crossOrigin: 'anonymous'
                }).addTo(map);

                // Criar marcadores de controle nos cantos
                createCornerMarkers();
                updateCoordsDisplay();
                
                // Ajustar view para mostrar a imagem
                map.fitBounds(imageBounds, { padding: [50, 50] });
            };
            
            tempImg.onerror = function() {
                // Tentar carregar mesmo sem CORS
                const opacity = parseFloat(document.getElementById('opacity').value);
                imageOverlay = L.imageOverlay(imageUrl, imageBounds, {
                    opacity: opacity,
                    interactive: false
                }).addTo(map);
                
                createCornerMarkers();
                updateCoordsDisplay();
                map.fitBounds(imageBounds, { padding: [50, 50] });
            };
            
            tempImg.src = imageUrl;
        }

        // ===== MARCADORES DE CONTROLE (CANTOS) =====
        function createCornerMarkers() {
            if (!imageBounds) return;

            const corners = {
                tl: imageBounds.getNorthWest(),
                tr: imageBounds.getNorthEast(),
                bl: imageBounds.getSouthWest(),
                br: imageBounds.getSouthEast()
            };

            const colors = {
                tl: '#ff6b6b',
                tr: '#4ecdc4',
                bl: '#ffe66d',
                br: '#95e1d3'
            };

            const labels = {
                tl: 'Noroeste (TL)',
                tr: 'Nordeste (TR)',
                bl: 'Sudoeste (BL)',
                br: 'Sudeste (BR)'
            };

            for (const [key, latLng] of Object.entries(corners)) {
                const icon = L.divIcon({
                    className: '',
                    html: `<div class="control-marker corner-${key}" style="background: ${colors[key]}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); cursor: grab;"></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const marker = L.marker(latLng, {
                    icon: icon,
                    draggable: true,
                    title: labels[key]
                }).addTo(map);

                marker.on('drag', function() {
                    updateImageBoundsFromMarkers();
                });

                marker.on('dragend', function() {
                    updateImageBoundsFromMarkers();
                    updateCoordsDisplay();
                });

                cornerMarkers[key] = marker;
            }
        }

        function removeCornerMarkers() {
            for (const key in cornerMarkers) {
                if (cornerMarkers[key]) {
                    map.removeLayer(cornerMarkers[key]);
                }
            }
            cornerMarkers = {};
        }

        function updateImageBoundsFromMarkers() {
            if (!imageOverlay) return;

            const tl = cornerMarkers.tl.getLatLng();
            const tr = cornerMarkers.tr.getLatLng();
            const bl = cornerMarkers.bl.getLatLng();
            const br = cornerMarkers.br.getLatLng();

            // Calcular novo bounds (usa m√©dia para formar ret√¢ngulo)
            const north = Math.max(tl.lat, tr.lat);
            const south = Math.min(bl.lat, br.lat);
            const west = Math.min(tl.lng, bl.lng);
            const east = Math.max(tr.lng, br.lng);

            imageBounds = L.latLngBounds([south, west], [north, east]);
            imageOverlay.setBounds(imageBounds);

            // Reposicionar markers para ficarem nos cantos exatos do novo bounds
            cornerMarkers.tl.setLatLng([north, west]);
            cornerMarkers.tr.setLatLng([north, east]);
            cornerMarkers.bl.setLatLng([south, west]);
            cornerMarkers.br.setLatLng([south, east]);
        }

        // ===== CARREGAMENTO DE IMAGEM LOCAL =====
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    loadImageAsOverlay(event.target.result, defaultBounds);
                };
                reader.readAsDataURL(file);
            }
        });

        function loadImageFromUrl() {
            const url = document.getElementById('imageUrl').value;
            if (url) {
                loadImageAsOverlay(url, defaultBounds);
            }
        }

        // ===== CONTROLES =====
        // Opacidade
        document.getElementById('opacity').addEventListener('input', function() {
            document.getElementById('opacityValue').value = this.value;
            if (imageOverlay) {
                imageOverlay.setOpacity(parseFloat(this.value));
            }
        });

        document.getElementById('opacityValue').addEventListener('change', function() {
            document.getElementById('opacity').value = this.value;
            if (imageOverlay) {
                imageOverlay.setOpacity(parseFloat(this.value));
            }
        });

        // Ajuste de bounds via controles num√©ricos
        function updateBoundsFromInputs() {
            if (!imageOverlay) return;

            const north = parseFloat(document.getElementById('boundNorth').value);
            const south = parseFloat(document.getElementById('boundSouth').value);
            const east = parseFloat(document.getElementById('boundEast').value);
            const west = parseFloat(document.getElementById('boundWest').value);

            if (isNaN(north) || isNaN(south) || isNaN(east) || isNaN(west)) return;

            imageBounds = L.latLngBounds([south, west], [north, east]);
            imageOverlay.setBounds(imageBounds);

            // Atualizar posi√ß√£o dos markers
            if (cornerMarkers.tl) cornerMarkers.tl.setLatLng([north, west]);
            if (cornerMarkers.tr) cornerMarkers.tr.setLatLng([north, east]);
            if (cornerMarkers.bl) cornerMarkers.bl.setLatLng([south, west]);
            if (cornerMarkers.br) cornerMarkers.br.setLatLng([south, east]);

            updateCoordsDisplay();
        }

        ['boundNorth', 'boundSouth', 'boundEast', 'boundWest'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateBoundsFromInputs);
        });

        // Toggles
        document.getElementById('showImage').addEventListener('change', function() {
            if (imageOverlay) {
                if (this.checked) {
                    imageOverlay.addTo(map);
                } else {
                    map.removeLayer(imageOverlay);
                }
            }
        });

        document.getElementById('showControlPoints').addEventListener('change', function() {
            for (const key in cornerMarkers) {
                if (this.checked) {
                    cornerMarkers[key].addTo(map);
                } else {
                    map.removeLayer(cornerMarkers[key]);
                }
            }
        });

        document.getElementById('lockDrag').addEventListener('change', function() {
            for (const key in cornerMarkers) {
                if (this.checked) {
                    cornerMarkers[key].dragging.disable();
                } else {
                    cornerMarkers[key].dragging.enable();
                }
            }
        });

        // ===== FUN√á√ïES DE A√á√ÉO =====
        function resetTransformations() {
            document.getElementById('opacity').value = 0.7;
            document.getElementById('opacityValue').value = 0.7;

            if (imageOverlay) {
                imageOverlay.setOpacity(0.7);
                
                // Resetar para bounds padr√£o
                const b = defaultBounds;
                imageBounds = L.latLngBounds([b.south, b.west], [b.north, b.east]);
                imageOverlay.setBounds(imageBounds);

                // Atualizar markers
                if (cornerMarkers.tl) cornerMarkers.tl.setLatLng([b.north, b.west]);
                if (cornerMarkers.tr) cornerMarkers.tr.setLatLng([b.north, b.east]);
                if (cornerMarkers.bl) cornerMarkers.bl.setLatLng([b.south, b.west]);
                if (cornerMarkers.br) cornerMarkers.br.setLatLng([b.south, b.east]);

                map.fitBounds(imageBounds, { padding: [50, 50] });
            }

            updateCoordsDisplay();
        }

        function fitImageToView() {
            if (imageBounds) {
                map.fitBounds(imageBounds, { padding: [50, 50] });
            }
        }

        function getAlignmentData() {
            if (!imageOverlay || !imageBounds) return null;

            const bounds = imageBounds;

            return {
                timestamp: new Date().toISOString(),
                mapCenter: { 
                    lat: map.getCenter().lat, 
                    lng: map.getCenter().lng 
                },
                mapZoom: map.getZoom(),
                imageUrl: currentImageUrl,
                originalImageSize: originalImageSize,
                opacity: parseFloat(document.getElementById('opacity').value),
                bounds: {
                    north: bounds.getNorth(),
                    south: bounds.getSouth(),
                    east: bounds.getEast(),
                    west: bounds.getWest()
                },
                corners: {
                    tl: { lat: bounds.getNorth(), lng: bounds.getWest() },
                    tr: { lat: bounds.getNorth(), lng: bounds.getEast() },
                    bl: { lat: bounds.getSouth(), lng: bounds.getWest() },
                    br: { lat: bounds.getSouth(), lng: bounds.getEast() }
                }
            };
        }

        function saveAlignment() {
            const data = getAlignmentData();
            if (!data) {
                alert('Carregue uma imagem primeiro!');
                return;
            }

            const json = JSON.stringify(data, null, 2);
            document.getElementById('resultJSON').textContent = json;
            document.getElementById('resultModal').style.display = 'flex';

            localStorage.setItem('satelliteAlignment', json);
            console.log('Alinhamento salvo:', data);
        }

        function exportAsJSON() {
            const data = getAlignmentData();
            if (!data) {
                alert('Carregue uma imagem primeiro!');
                return;
            }
            downloadJSONData(data);
        }

        function downloadJSONData(data) {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `satellite_alignment_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadJSON() {
            const data = getAlignmentData();
            if (data) {
                downloadJSONData(data);
            }
        }

        function loadFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const data = JSON.parse(event.target.result);
                            applyAlignmentData(data);
                        } catch (err) {
                            alert('Erro ao ler arquivo JSON: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function applyAlignmentData(data) {
            // Aplicar opacidade
            if (data.opacity !== undefined) {
                document.getElementById('opacity').value = data.opacity;
                document.getElementById('opacityValue').value = data.opacity;
            }

            // Carregar imagem com bounds salvos
            if (data.imageUrl && data.bounds) {
                loadImageAsOverlay(data.imageUrl, data.bounds);
            }

            // Aplicar view do mapa
            if (data.mapCenter && data.mapZoom) {
                map.setView([data.mapCenter.lat, data.mapCenter.lng], data.mapZoom);
            }
        }

        function copyToClipboard() {
            const text = document.getElementById('resultJSON').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('JSON copiado para a √°rea de transfer√™ncia!');
            });
        }

        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        function updateCoordsDisplay() {
            const data = getAlignmentData();
            if (!data) {
                document.getElementById('coordsDisplay').innerHTML = 'Carregue uma imagem para ver as coordenadas';
                return;
            }

            // Atualizar inputs de bounds
            document.getElementById('boundNorth').value = data.bounds.north.toFixed(4);
            document.getElementById('boundSouth').value = data.bounds.south.toFixed(4);
            document.getElementById('boundEast').value = data.bounds.east.toFixed(4);
            document.getElementById('boundWest').value = data.bounds.west.toFixed(4);

            const html = `
<b>Bounding Box:</b>
Norte: ${data.bounds.north.toFixed(4)}¬∞
Sul: ${data.bounds.south.toFixed(4)}¬∞
Leste: ${data.bounds.east.toFixed(4)}¬∞
Oeste: ${data.bounds.west.toFixed(4)}¬∞

<b>Dimens√µes:</b>
Lat: ${(data.bounds.north - data.bounds.south).toFixed(2)}¬∞
Lng: ${(data.bounds.east - data.bounds.west).toFixed(2)}¬∞

<b>Zoom atual:</b> ${map.getZoom().toFixed(2)}
            `;
            document.getElementById('coordsDisplay').innerHTML = html;
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', function() {
            initMap();

            // Carregar alinhamento anterior se existir
            const saved = localStorage.getItem('satelliteAlignment');
            if (saved) {
                console.log('Alinhamento anterior encontrado no localStorage');
            }
        });

        // ===== GCP (GROUND CONTROL POINTS) =====
        function toggleGcpMode() {
            gcpMode = !gcpMode;
            const btn = document.getElementById('btnGcpMode');
            const instructions = document.getElementById('gcpInstructions');
            
            if (gcpMode) {
                btn.classList.add('gcp-mode-active');
                btn.innerHTML = 'üéØ MODO ATIVO - Clique no mapa!';
                instructions.classList.add('active');
                map.getContainer().style.cursor = 'crosshair';
                
                // Adicionar listener de clique
                map.on('click', onMapClickGcp);
            } else {
                btn.classList.remove('gcp-mode-active');
                btn.innerHTML = 'üéØ Marcar Pontos no Mapa';
                instructions.classList.remove('active');
                map.getContainer().style.cursor = '';
                
                // Remover listener
                map.off('click', onMapClickGcp);
            }
        }

        function onMapClickGcp(e) {
            if (!gcpMode) return;
            
            gcpCounter++;
            const id = gcpCounter;
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Criar marcador
            const icon = L.divIcon({
                className: '',
                html: `<div class="gcp-marker">${id}</div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            const marker = L.marker([lat, lng], {
                icon: icon,
                draggable: true
            }).addTo(map);
            
            // Atualizar coordenadas quando arrastar
            marker.on('dragend', function() {
                const pos = marker.getLatLng();
                const point = gcpPoints.find(p => p.id === id);
                if (point) {
                    point.lat = pos.lat;
                    point.lng = pos.lng;
                    updateGcpList();
                }
            });
            
            // Adicionar ao array
            gcpPoints.push({ marker, lat, lng, id });
            
            // Atualizar lista visual
            updateGcpList();
        }

        function updateGcpList() {
            const listEl = document.getElementById('gcpList');
            
            if (gcpPoints.length === 0) {
                listEl.innerHTML = '<p style="color:#888; font-size:0.85em;">Nenhum ponto marcado ainda</p>';
                return;
            }
            
            let html = '';
            gcpPoints.forEach((point, index) => {
                html += `
                    <div class="gcp-item" data-id="${point.id}">
                        <span class="gcp-number">${point.id}</span>
                        <span style="color:#888;">Lat:</span>
                        <input type="number" step="0.0001" value="${point.lat.toFixed(4)}" 
                               onchange="updateGcpCoord(${point.id}, 'lat', this.value)">
                        <span style="color:#888;">Lng:</span>
                        <input type="number" step="0.0001" value="${point.lng.toFixed(4)}" 
                               onchange="updateGcpCoord(${point.id}, 'lng', this.value)">
                        <button onclick="removeGcpPoint(${point.id})">√ó</button>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }

        function updateGcpCoord(id, field, value) {
            const point = gcpPoints.find(p => p.id === id);
            if (point) {
                point[field] = parseFloat(value);
                point.marker.setLatLng([point.lat, point.lng]);
            }
        }

        function removeGcpPoint(id) {
            const index = gcpPoints.findIndex(p => p.id === id);
            if (index !== -1) {
                map.removeLayer(gcpPoints[index].marker);
                gcpPoints.splice(index, 1);
                updateGcpList();
            }
        }

        function clearAllGcpPoints() {
            gcpPoints.forEach(point => {
                map.removeLayer(point.marker);
            });
            gcpPoints = [];
            gcpCounter = 0;
            updateGcpList();
        }

        function alignFromGcpPoints() {
            if (gcpPoints.length < 2) {
                alert('Voc√™ precisa de pelo menos 2 pontos de refer√™ncia para alinhar a imagem!');
                return;
            }
            
            if (!imageOverlay) {
                alert('Carregue uma imagem primeiro!');
                return;
            }
            
            // Calcular bounding box a partir dos pontos GCP
            let minLat = Infinity, maxLat = -Infinity;
            let minLng = Infinity, maxLng = -Infinity;
            
            gcpPoints.forEach(point => {
                minLat = Math.min(minLat, point.lat);
                maxLat = Math.max(maxLat, point.lat);
                minLng = Math.min(minLng, point.lng);
                maxLng = Math.max(maxLng, point.lng);
            });
            
            // Adicionar margem proporcional (10% de cada lado)
            const latRange = maxLat - minLat;
            const lngRange = maxLng - minLng;
            
            // Se temos s√≥ 2 pontos, eles definem os extremos
            // Se temos mais pontos, usamos eles como √°rea de interesse
            
            // Ajustar bounds - calcular propor√ß√£o da imagem
            const imageAspect = originalImageSize.width / originalImageSize.height;
            const currentAspect = lngRange / latRange;
            
            let finalNorth, finalSouth, finalEast, finalWest;
            
            if (gcpPoints.length === 2) {
                // Com 2 pontos, assumimos que s√£o cantos opostos (ex: NW e SE)
                finalNorth = maxLat;
                finalSouth = minLat;
                finalEast = maxLng;
                finalWest = minLng;
            } else {
                // Com 3+ pontos, adicionamos margem
                const marginLat = latRange * 0.1;
                const marginLng = lngRange * 0.1;
                
                finalNorth = maxLat + marginLat;
                finalSouth = minLat - marginLat;
                finalEast = maxLng + marginLng;
                finalWest = minLng - marginLng;
            }
            
            // Aplicar novo bounds
            imageBounds = L.latLngBounds([finalSouth, finalWest], [finalNorth, finalEast]);
            imageOverlay.setBounds(imageBounds);
            
            // Atualizar markers de canto
            if (cornerMarkers.tl) cornerMarkers.tl.setLatLng([finalNorth, finalWest]);
            if (cornerMarkers.tr) cornerMarkers.tr.setLatLng([finalNorth, finalEast]);
            if (cornerMarkers.bl) cornerMarkers.bl.setLatLng([finalSouth, finalWest]);
            if (cornerMarkers.br) cornerMarkers.br.setLatLng([finalSouth, finalEast]);
            
            // Atualizar view
            map.fitBounds(imageBounds, { padding: [50, 50] });
            
            updateCoordsDisplay();
            
            // Feedback visual
            const status = document.getElementById('satStatus');
            status.innerHTML = `‚úÖ Imagem alinhada com ${gcpPoints.length} pontos de refer√™ncia!`;
            status.style.color = '#00ff00';
        }
    </script>
</body>
</html>
